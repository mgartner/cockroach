# Regression test for #120439 - don't allow subquery hoisting that violates
# PL/pgSQL subroutine ordering.
exec-ddl
CREATE OR REPLACE PROCEDURE p(x INT) AS $$
  BEGIN
    IF pg_sleep(0.1) IS NOT NULL THEN
      RAISE NOTICE 'foo %', x;
    ELSE
      SELECT x;
    END IF;
  END
$$ LANGUAGE PLpgSQL;
----

# The subquery hoisting rules shouldn't pull subroutine tail calls out of a
# CASE statement.
norm expect-not=HoistValuesSubquery format=show-scalars
CALL p(1);
----
call
 ├── cardinality: [0 - 0]
 ├── volatile
 └── procedure: p
      ├── args
      │    └── const: 1
      ├── params: $1
      └── body
           └── values
                ├── columns: stmt_if_5:8
                ├── cardinality: [1 - 1]
                ├── volatile, has-placeholder
                ├── key: ()
                ├── fd: ()-->(8)
                └── tuple
                     └── case
                          ├── true
                          ├── when
                          │    ├── is-not
                          │    │    ├── function: pg_sleep
                          │    │    │    └── const: 0.1
                          │    │    └── null
                          │    └── udf: _stmt_raise_2
                          │         ├── tail-call
                          │         ├── args
                          │         │    └── placeholder: $1
                          │         ├── params: $1
                          │         └── body
                          │              ├── values
                          │              │    ├── columns: stmt_raise_3:2
                          │              │    ├── cardinality: [1 - 1]
                          │              │    ├── volatile, has-placeholder
                          │              │    ├── key: ()
                          │              │    ├── fd: ()-->(2)
                          │              │    └── tuple
                          │              │         └── function: crdb_internal.plpgsql_raise
                          │              │              ├── const: 'NOTICE'
                          │              │              ├── concat
                          │              │              │    ├── concat
                          │              │              │    │    ├── const: 'foo '
                          │              │              │    │    └── coalesce
                          │              │              │    │         ├── cast: STRING
                          │              │              │    │         │    └── placeholder: $1
                          │              │              │    │         └── const: '<NULL>'
                          │              │              │    └── const: ''
                          │              │              ├── const: ''
                          │              │              ├── const: ''
                          │              │              └── const: '00000'
                          │              └── values
                          │                   ├── columns: stmt_if_1:3
                          │                   ├── cardinality: [1 - 1]
                          │                   ├── key: ()
                          │                   ├── fd: ()-->(3)
                          │                   └── tuple
                          │                        └── subquery
                          │                             ├── tail-call
                          │                             └── values
                          │                                  ├── columns: "_implicit_return":1
                          │                                  ├── cardinality: [1 - 1]
                          │                                  ├── key: ()
                          │                                  ├── fd: ()-->(1)
                          │                                  └── tuple
                          │                                       └── null
                          └── udf: _stmt_exec_4
                               ├── tail-call
                               ├── args
                               │    └── placeholder: $1
                               ├── params: $1
                               └── body
                                    ├── values
                                    │    ├── columns: x:5
                                    │    ├── cardinality: [1 - 1]
                                    │    ├── has-placeholder
                                    │    ├── key: ()
                                    │    ├── fd: ()-->(5)
                                    │    └── tuple
                                    │         └── placeholder: $1
                                    └── values
                                         ├── columns: stmt_if_1:6
                                         ├── cardinality: [1 - 1]
                                         ├── key: ()
                                         ├── fd: ()-->(6)
                                         └── tuple
                                              └── subquery
                                                   ├── tail-call
                                                   └── values
                                                        ├── columns: "_implicit_return":1
                                                        ├── cardinality: [1 - 1]
                                                        ├── key: ()
                                                        ├── fd: ()-->(1)
                                                        └── tuple
                                                             └── null
