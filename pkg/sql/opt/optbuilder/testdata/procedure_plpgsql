exec-ddl
CREATE TABLE t (
  k INT PRIMARY KEY,
  i INT,
  s STRING
)
----

exec-ddl
CREATE PROCEDURE my_upsert(arg_k INT, new_i INT, new_s STRING) AS $$
  DECLARE
    c INT;
  BEGIN
    SELECT count(*) INTO c FROM t WHERE k = arg_k;
    IF c > 0 THEN
      UPDATE t SET i = new_i, s = new_s WHERE k = arg_k;
    ELSE
      INSERT INTO t VALUES (arg_k, new_i, new_s);
    END IF;
  END
$$ LANGUAGE PLpgSQL
----

build format=show-scalars
CALL my_upsert(1, 10, 'foo')
----
call
 └── procedure: my_upsert
      ├── args
      │    ├── const: 1
      │    ├── const: 10
      │    └── const: 'foo'
      ├── params: $1 $2 $3
      └── body
           └── limit
                ├── columns: "_stmt_exec_1":36
                ├── project
                │    ├── columns: "_stmt_exec_1":36
                │    ├── barrier
                │    │    ├── columns: c:1
                │    │    └── project
                │    │         ├── columns: c:1
                │    │         ├── values
                │    │         │    └── tuple
                │    │         └── projections
                │    │              └── cast: INT8 [as=c:1]
                │    │                   └── null
                │    └── projections
                │         └── udf: _stmt_exec_1 [as="_stmt_exec_1":36]
                │              ├── args
                │              │    ├── placeholder: $1
                │              │    ├── placeholder: $2
                │              │    ├── placeholder: $3
                │              │    └── variable: c:1
                │              ├── params: $1 $2 $3 $4
                │              └── body
                │                   └── project
                │                        ├── columns: "_stmt_exec_ret_2":35
                │                        ├── barrier
                │                        │    ├── columns: c:34
                │                        │    └── project
                │                        │         ├── columns: c:34
                │                        │         ├── right-join (cross)
                │                        │         │    ├── columns: count_rows:7
                │                        │         │    ├── limit
                │                        │         │    │    ├── columns: count_rows:7!null
                │                        │         │    │    ├── scalar-group-by
                │                        │         │    │    │    ├── columns: count_rows:7!null
                │                        │         │    │    │    ├── project
                │                        │         │    │    │    │    └── select
                │                        │         │    │    │    │         ├── columns: k:2!null i:3 s:4 crdb_internal_mvcc_timestamp:5 tableoid:6
                │                        │         │    │    │    │         ├── scan t
                │                        │         │    │    │    │         │    └── columns: k:2!null i:3 s:4 crdb_internal_mvcc_timestamp:5 tableoid:6
                │                        │         │    │    │    │         └── filters
                │                        │         │    │    │    │              └── eq
                │                        │         │    │    │    │                   ├── variable: k:2
                │                        │         │    │    │    │                   └── placeholder: $1
                │                        │         │    │    │    └── aggregations
                │                        │         │    │    │         └── count-rows [as=count_rows:7]
                │                        │         │    │    └── const: 1
                │                        │         │    ├── values
                │                        │         │    │    └── tuple
                │                        │         │    └── filters (true)
                │                        │         └── projections
                │                        │              └── variable: count_rows:7 [as=c:34]
                │                        └── projections
                │                             └── udf: _stmt_exec_ret_2 [as="_stmt_exec_ret_2":35]
                │                                  ├── tail-call
                │                                  ├── args
                │                                  │    ├── placeholder: $1
                │                                  │    ├── placeholder: $2
                │                                  │    ├── placeholder: $3
                │                                  │    └── variable: c:34
                │                                  ├── params: $1 $2 $3 $4
                │                                  └── body
                │                                       └── project
                │                                            ├── columns: stmt_if_6:33
                │                                            ├── values
                │                                            │    └── tuple
                │                                            └── projections
                │                                                 └── case [as=stmt_if_6:33]
                │                                                      ├── true
                │                                                      ├── when
                │                                                      │    ├── gt
                │                                                      │    │    ├── placeholder: $4
                │                                                      │    │    └── const: 0
                │                                                      │    └── subquery
                │                                                      │         ├── tail-call
                │                                                      │         └── project
                │                                                      │              ├── columns: "_stmt_exec_4":22
                │                                                      │              ├── values
                │                                                      │              │    └── tuple
                │                                                      │              └── projections
                │                                                      │                   └── udf: _stmt_exec_4 [as="_stmt_exec_4":22]
                │                                                      │                        ├── tail-call
                │                                                      │                        ├── args
                │                                                      │                        │    ├── placeholder: $1
                │                                                      │                        │    ├── placeholder: $2
                │                                                      │                        │    ├── placeholder: $3
                │                                                      │                        │    └── placeholder: $4
                │                                                      │                        ├── params: $1 $2 $3 $4
                │                                                      │                        └── body
                │                                                      │                             ├── update t
                │                                                      │                             │    ├── columns: <none>
                │                                                      │                             │    ├── fetch columns: k:14 i:15 s:16
                │                                                      │                             │    ├── update-mapping:
                │                                                      │                             │    │    ├── i_new:19 => i:10
                │                                                      │                             │    │    └── s_cast:20 => s:11
                │                                                      │                             │    └── project
                │                                                      │                             │         ├── columns: s_cast:20 k:14!null i:15 s:16 crdb_internal_mvcc_timestamp:17 tableoid:18 i_new:19
                │                                                      │                             │         ├── project
                │                                                      │                             │         │    ├── columns: i_new:19 k:14!null i:15 s:16 crdb_internal_mvcc_timestamp:17 tableoid:18
                │                                                      │                             │         │    ├── select
                │                                                      │                             │         │    │    ├── columns: k:14!null i:15 s:16 crdb_internal_mvcc_timestamp:17 tableoid:18
                │                                                      │                             │         │    │    ├── scan t
                │                                                      │                             │         │    │    │    ├── columns: k:14!null i:15 s:16 crdb_internal_mvcc_timestamp:17 tableoid:18
                │                                                      │                             │         │    │    │    └── flags: avoid-full-scan
                │                                                      │                             │         │    │    └── filters
                │                                                      │                             │         │    │         └── eq
                │                                                      │                             │         │    │              ├── variable: k:14
                │                                                      │                             │         │    │              └── placeholder: $1
                │                                                      │                             │         │    └── projections
                │                                                      │                             │         │         └── placeholder: $2 [as=i_new:19]
                │                                                      │                             │         └── projections
                │                                                      │                             │              └── assignment-cast: STRING [as=s_cast:20]
                │                                                      │                             │                   └── variable: i_new:19
                │                                                      │                             └── project
                │                                                      │                                  ├── columns: stmt_if_3:21
                │                                                      │                                  ├── values
                │                                                      │                                  │    └── tuple
                │                                                      │                                  └── projections
                │                                                      │                                       └── udf: stmt_if_3 [as=stmt_if_3:21]
                │                                                      │                                            ├── tail-call
                │                                                      │                                            ├── args
                │                                                      │                                            │    ├── placeholder: $1
                │                                                      │                                            │    ├── placeholder: $2
                │                                                      │                                            │    ├── placeholder: $3
                │                                                      │                                            │    └── placeholder: $4
                │                                                      │                                            ├── params: $1 $2 $3 $4
                │                                                      │                                            └── body
                │                                                      │                                                 └── project
                │                                                      │                                                      ├── columns: "_implicit_return":8
                │                                                      │                                                      ├── values
                │                                                      │                                                      │    └── tuple
                │                                                      │                                                      └── projections
                │                                                      │                                                           └── cast: VOID [as="_implicit_return":8]
                │                                                      │                                                                └── null
                │                                                      └── subquery
                │                                                           ├── tail-call
                │                                                           └── project
                │                                                                ├── columns: "_stmt_exec_5":32
                │                                                                ├── values
                │                                                                │    └── tuple
                │                                                                └── projections
                │                                                                     └── udf: _stmt_exec_5 [as="_stmt_exec_5":32]
                │                                                                          ├── tail-call
                │                                                                          ├── args
                │                                                                          │    ├── placeholder: $1
                │                                                                          │    ├── placeholder: $2
                │                                                                          │    ├── placeholder: $3
                │                                                                          │    └── placeholder: $4
                │                                                                          ├── params: $1 $2 $3 $4
                │                                                                          └── body
                │                                                                               ├── insert t
                │                                                                               │    ├── columns: <none>
                │                                                                               │    ├── insert-mapping:
                │                                                                               │    │    ├── column1:28 => k:23
                │                                                                               │    │    ├── column2:29 => i:24
                │                                                                               │    │    └── column3:30 => s:25
                │                                                                               │    └── values
                │                                                                               │         ├── columns: column1:28 column2:29 column3:30
                │                                                                               │         └── tuple
                │                                                                               │              ├── placeholder: $1
                │                                                                               │              ├── placeholder: $2
                │                                                                               │              └── placeholder: $3
                │                                                                               └── project
                │                                                                                    ├── columns: stmt_if_3:31
                │                                                                                    ├── values
                │                                                                                    │    └── tuple
                │                                                                                    └── projections
                │                                                                                         └── udf: stmt_if_3 [as=stmt_if_3:31]
                │                                                                                              ├── tail-call
                │                                                                                              ├── args
                │                                                                                              │    ├── placeholder: $1
                │                                                                                              │    ├── placeholder: $2
                │                                                                                              │    ├── placeholder: $3
                │                                                                                              │    └── placeholder: $4
                │                                                                                              ├── params: $1 $2 $3 $4
                │                                                                                              └── body
                │                                                                                                   └── project
                │                                                                                                        ├── columns: "_implicit_return":8
                │                                                                                                        ├── values
                │                                                                                                        │    └── tuple
                │                                                                                                        └── projections
                │                                                                                                             └── cast: VOID [as="_implicit_return":8]
                │                                                                                                                  └── null
                └── const: 1

# Case with nested blocks.
exec-ddl
CREATE OR REPLACE PROCEDURE p(x INT) AS $$
  DECLARE
    y INT := 10;
  BEGIN
    x := x + 1;
    y := y + 1;
    RAISE NOTICE '% %', x, y;
    DECLARE
      z INT := 100;
    BEGIN
      x := x + 1;
      y := y + 1;
      z := z + 1;
      RAISE NOTICE '% % %', x, y, z;
    END;
    x := x + 1;
    y := y + 1;
    RAISE NOTICE '% %', x, y;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
CALL p(5)
----
call
 └── procedure: p
      ├── args
      │    └── const: 5
      ├── params: $1
      └── body
           └── limit
                ├── columns: "_stmt_raise_1":17
                ├── project
                │    ├── columns: "_stmt_raise_1":17
                │    ├── barrier
                │    │    ├── columns: x:2 y:3!null
                │    │    └── project
                │    │         ├── columns: y:3!null x:2
                │    │         ├── project
                │    │         │    ├── columns: x:2 y:1!null
                │    │         │    ├── project
                │    │         │    │    ├── columns: y:1!null
                │    │         │    │    ├── values
                │    │         │    │    │    └── tuple
                │    │         │    │    └── projections
                │    │         │    │         └── const: 10 [as=y:1]
                │    │         │    └── projections
                │    │         │         └── plus [as=x:2]
                │    │         │              ├── placeholder: $1
                │    │         │              └── const: 1
                │    │         └── projections
                │    │              └── plus [as=y:3]
                │    │                   ├── variable: y:1
                │    │                   └── const: 1
                │    └── projections
                │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":17]
                │              ├── args
                │              │    ├── variable: x:2
                │              │    └── variable: y:3
                │              ├── params: $1 $2
                │              └── body
                │                   ├── project
                │                   │    ├── columns: stmt_raise_2:4
                │                   │    ├── values
                │                   │    │    └── tuple
                │                   │    └── projections
                │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:4]
                │                   │              ├── const: 'NOTICE'
                │                   │              ├── concat
                │                   │              │    ├── concat
                │                   │              │    │    ├── concat
                │                   │              │    │    │    ├── concat
                │                   │              │    │    │    │    ├── const: ''
                │                   │              │    │    │    │    └── coalesce
                │                   │              │    │    │    │         ├── cast: STRING
                │                   │              │    │    │    │         │    └── placeholder: $1
                │                   │              │    │    │    │         └── const: '<NULL>'
                │                   │              │    │    │    └── const: ' '
                │                   │              │    │    └── coalesce
                │                   │              │    │         ├── cast: STRING
                │                   │              │    │         │    └── placeholder: $2
                │                   │              │    │         └── const: '<NULL>'
                │                   │              │    └── const: ''
                │                   │              ├── const: ''
                │                   │              ├── const: ''
                │                   │              └── const: '00000'
                │                   └── project
                │                        ├── columns: "_stmt_raise_6":16
                │                        ├── barrier
                │                        │    ├── columns: x:11 y:12 z:13!null
                │                        │    └── project
                │                        │         ├── columns: z:13!null x:11 y:12
                │                        │         ├── project
                │                        │         │    ├── columns: y:12 z:10!null x:11
                │                        │         │    ├── project
                │                        │         │    │    ├── columns: x:11 z:10!null
                │                        │         │    │    ├── project
                │                        │         │    │    │    ├── columns: z:10!null
                │                        │         │    │    │    ├── values
                │                        │         │    │    │    │    └── tuple
                │                        │         │    │    │    └── projections
                │                        │         │    │    │         └── const: 100 [as=z:10]
                │                        │         │    │    └── projections
                │                        │         │    │         └── plus [as=x:11]
                │                        │         │    │              ├── placeholder: $1
                │                        │         │    │              └── const: 1
                │                        │         │    └── projections
                │                        │         │         └── plus [as=y:12]
                │                        │         │              ├── placeholder: $2
                │                        │         │              └── const: 1
                │                        │         └── projections
                │                        │              └── plus [as=z:13]
                │                        │                   ├── variable: z:10
                │                        │                   └── const: 1
                │                        └── projections
                │                             └── udf: _stmt_raise_6 [as="_stmt_raise_6":16]
                │                                  ├── tail-call
                │                                  ├── args
                │                                  │    ├── variable: x:11
                │                                  │    ├── variable: y:12
                │                                  │    └── variable: z:13
                │                                  ├── params: $1 $2 $3
                │                                  └── body
                │                                       ├── project
                │                                       │    ├── columns: stmt_raise_7:14
                │                                       │    ├── values
                │                                       │    │    └── tuple
                │                                       │    └── projections
                │                                       │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_7:14]
                │                                       │              ├── const: 'NOTICE'
                │                                       │              ├── concat
                │                                       │              │    ├── concat
                │                                       │              │    │    ├── concat
                │                                       │              │    │    │    ├── concat
                │                                       │              │    │    │    │    ├── concat
                │                                       │              │    │    │    │    │    ├── concat
                │                                       │              │    │    │    │    │    │    ├── const: ''
                │                                       │              │    │    │    │    │    │    └── coalesce
                │                                       │              │    │    │    │    │    │         ├── cast: STRING
                │                                       │              │    │    │    │    │    │         │    └── placeholder: $1
                │                                       │              │    │    │    │    │    │         └── const: '<NULL>'
                │                                       │              │    │    │    │    │    └── const: ' '
                │                                       │              │    │    │    │    └── coalesce
                │                                       │              │    │    │    │         ├── cast: STRING
                │                                       │              │    │    │    │         │    └── placeholder: $2
                │                                       │              │    │    │    │         └── const: '<NULL>'
                │                                       │              │    │    │    └── const: ' '
                │                                       │              │    │    └── coalesce
                │                                       │              │    │         ├── cast: STRING
                │                                       │              │    │         │    └── placeholder: $3
                │                                       │              │    │         └── const: '<NULL>'
                │                                       │              │    └── const: ''
                │                                       │              ├── const: ''
                │                                       │              ├── const: ''
                │                                       │              └── const: '00000'
                │                                       └── project
                │                                            ├── columns: post_nested_block_3:15
                │                                            ├── values
                │                                            │    └── tuple
                │                                            └── projections
                │                                                 └── udf: post_nested_block_3 [as=post_nested_block_3:15]
                │                                                      ├── tail-call
                │                                                      ├── args
                │                                                      │    ├── placeholder: $1
                │                                                      │    └── placeholder: $2
                │                                                      ├── params: $1 $2
                │                                                      └── body
                │                                                           └── project
                │                                                                ├── columns: "_stmt_raise_4":9
                │                                                                ├── barrier
                │                                                                │    ├── columns: x:5 y:6
                │                                                                │    └── project
                │                                                                │         ├── columns: y:6 x:5
                │                                                                │         ├── project
                │                                                                │         │    ├── columns: x:5
                │                                                                │         │    ├── values
                │                                                                │         │    │    └── tuple
                │                                                                │         │    └── projections
                │                                                                │         │         └── plus [as=x:5]
                │                                                                │         │              ├── placeholder: $1
                │                                                                │         │              └── const: 1
                │                                                                │         └── projections
                │                                                                │              └── plus [as=y:6]
                │                                                                │                   ├── placeholder: $2
                │                                                                │                   └── const: 1
                │                                                                └── projections
                │                                                                     └── udf: _stmt_raise_4 [as="_stmt_raise_4":9]
                │                                                                          ├── tail-call
                │                                                                          ├── args
                │                                                                          │    ├── variable: x:5
                │                                                                          │    └── variable: y:6
                │                                                                          ├── params: $1 $2
                │                                                                          └── body
                │                                                                               ├── project
                │                                                                               │    ├── columns: stmt_raise_5:7
                │                                                                               │    ├── values
                │                                                                               │    │    └── tuple
                │                                                                               │    └── projections
                │                                                                               │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_5:7]
                │                                                                               │              ├── const: 'NOTICE'
                │                                                                               │              ├── concat
                │                                                                               │              │    ├── concat
                │                                                                               │              │    │    ├── concat
                │                                                                               │              │    │    │    ├── concat
                │                                                                               │              │    │    │    │    ├── const: ''
                │                                                                               │              │    │    │    │    └── coalesce
                │                                                                               │              │    │    │    │         ├── cast: STRING
                │                                                                               │              │    │    │    │         │    └── placeholder: $1
                │                                                                               │              │    │    │    │         └── const: '<NULL>'
                │                                                                               │              │    │    │    └── const: ' '
                │                                                                               │              │    │    └── coalesce
                │                                                                               │              │    │         ├── cast: STRING
                │                                                                               │              │    │         │    └── placeholder: $2
                │                                                                               │              │    │         └── const: '<NULL>'
                │                                                                               │              │    └── const: ''
                │                                                                               │              ├── const: ''
                │                                                                               │              ├── const: ''
                │                                                                               │              └── const: '00000'
                │                                                                               └── project
                │                                                                                    ├── columns: "_implicit_return":8
                │                                                                                    ├── values
                │                                                                                    │    └── tuple
                │                                                                                    └── projections
                │                                                                                         └── cast: VOID [as="_implicit_return":8]
                │                                                                                              └── null
                └── const: 1

# Nested blocks with an exception handler. Note that the exception handler
# returns control to the outer block, so that the variable assignment is
# visible in the outer block.
exec-ddl
CREATE OR REPLACE PROCEDURE p() AS $$
  DECLARE
    x INT := 0;
  BEGIN
    RAISE NOTICE '%', x;
    BEGIN
      SELECT 1 // 0;
    EXCEPTION
      WHEN division_by_zero THEN
        x := 100;
    END;
    RAISE NOTICE '%', x;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
CALL p()
----
call
 └── procedure: p
      └── body
           └── limit
                ├── columns: "_stmt_raise_1":12
                ├── project
                │    ├── columns: "_stmt_raise_1":12
                │    ├── barrier
                │    │    ├── columns: x:1!null
                │    │    └── project
                │    │         ├── columns: x:1!null
                │    │         ├── values
                │    │         │    └── tuple
                │    │         └── projections
                │    │              └── const: 0 [as=x:1]
                │    └── projections
                │         └── udf: _stmt_raise_1 [as="_stmt_raise_1":12]
                │              ├── args
                │              │    └── variable: x:1
                │              ├── params: $1
                │              └── body
                │                   ├── project
                │                   │    ├── columns: stmt_raise_2:2
                │                   │    ├── values
                │                   │    │    └── tuple
                │                   │    └── projections
                │                   │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_2:2]
                │                   │              ├── const: 'NOTICE'
                │                   │              ├── concat
                │                   │              │    ├── concat
                │                   │              │    │    ├── const: ''
                │                   │              │    │    └── coalesce
                │                   │              │    │         ├── cast: STRING
                │                   │              │    │         │    └── placeholder: $1
                │                   │              │    │         └── const: '<NULL>'
                │                   │              │    └── const: ''
                │                   │              ├── const: ''
                │                   │              ├── const: ''
                │                   │              └── const: '00000'
                │                   └── project
                │                        ├── columns: nested_block_7:11
                │                        ├── values
                │                        │    └── tuple
                │                        └── projections
                │                             └── udf: nested_block_7 [as=nested_block_7:11]
                │                                  ├── tail-call
                │                                  ├── args
                │                                  │    └── placeholder: $1
                │                                  ├── params: $1
                │                                  ├── body
                │                                  │    └── project
                │                                  │         ├── columns: "_stmt_exec_8":10
                │                                  │         ├── values
                │                                  │         │    └── tuple
                │                                  │         └── projections
                │                                  │              └── udf: _stmt_exec_8 [as="_stmt_exec_8":10]
                │                                  │                   ├── tail-call
                │                                  │                   ├── args
                │                                  │                   │    └── placeholder: $1
                │                                  │                   ├── params: $1
                │                                  │                   └── body
                │                                  │                        ├── project
                │                                  │                        │    ├── columns: "?column?":8!null
                │                                  │                        │    ├── values
                │                                  │                        │    │    └── tuple
                │                                  │                        │    └── projections
                │                                  │                        │         └── floor-div [as="?column?":8]
                │                                  │                        │              ├── const: 1
                │                                  │                        │              └── const: 0
                │                                  │                        └── project
                │                                  │                             ├── columns: post_nested_block_3:9
                │                                  │                             ├── values
                │                                  │                             │    └── tuple
                │                                  │                             └── projections
                │                                  │                                  └── udf: post_nested_block_3 [as=post_nested_block_3:9]
                │                                  │                                       ├── tail-call
                │                                  │                                       ├── args
                │                                  │                                       │    └── placeholder: $1
                │                                  │                                       ├── params: $1
                │                                  │                                       └── body
                │                                  │                                            └── project
                │                                  │                                                 ├── columns: "_stmt_raise_4":5
                │                                  │                                                 ├── values
                │                                  │                                                 │    └── tuple
                │                                  │                                                 └── projections
                │                                  │                                                      └── udf: _stmt_raise_4 [as="_stmt_raise_4":5]
                │                                  │                                                           ├── tail-call
                │                                  │                                                           ├── args
                │                                  │                                                           │    └── placeholder: $1
                │                                  │                                                           ├── params: $1
                │                                  │                                                           └── body
                │                                  │                                                                ├── project
                │                                  │                                                                │    ├── columns: stmt_raise_5:3
                │                                  │                                                                │    ├── values
                │                                  │                                                                │    │    └── tuple
                │                                  │                                                                │    └── projections
                │                                  │                                                                │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_5:3]
                │                                  │                                                                │              ├── const: 'NOTICE'
                │                                  │                                                                │              ├── concat
                │                                  │                                                                │              │    ├── concat
                │                                  │                                                                │              │    │    ├── const: ''
                │                                  │                                                                │              │    │    └── coalesce
                │                                  │                                                                │              │    │         ├── cast: STRING
                │                                  │                                                                │              │    │         │    └── placeholder: $1
                │                                  │                                                                │              │    │         └── const: '<NULL>'
                │                                  │                                                                │              │    └── const: ''
                │                                  │                                                                │              ├── const: ''
                │                                  │                                                                │              ├── const: ''
                │                                  │                                                                │              └── const: '00000'
                │                                  │                                                                └── project
                │                                  │                                                                     ├── columns: "_implicit_return":4
                │                                  │                                                                     ├── values
                │                                  │                                                                     │    └── tuple
                │                                  │                                                                     └── projections
                │                                  │                                                                          └── cast: VOID [as="_implicit_return":4]
                │                                  │                                                                               └── null
                │                                  └── exception-handler
                │                                       └── SQLSTATE '22012'
                │                                            └── project
                │                                                 ├── columns: post_nested_block_3:7
                │                                                 ├── barrier
                │                                                 │    ├── columns: x:6!null
                │                                                 │    └── project
                │                                                 │         ├── columns: x:6!null
                │                                                 │         ├── values
                │                                                 │         │    └── tuple
                │                                                 │         └── projections
                │                                                 │              └── const: 100 [as=x:6]
                │                                                 └── projections
                │                                                      └── udf: post_nested_block_3 [as=post_nested_block_3:7]
                │                                                           ├── args
                │                                                           │    └── variable: x:6
                │                                                           ├── params: $1
                │                                                           └── body
                │                                                                └── project
                │                                                                     ├── columns: "_stmt_raise_4":5
                │                                                                     ├── values
                │                                                                     │    └── tuple
                │                                                                     └── projections
                │                                                                          └── udf: _stmt_raise_4 [as="_stmt_raise_4":5]
                │                                                                               ├── tail-call
                │                                                                               ├── args
                │                                                                               │    └── placeholder: $1
                │                                                                               ├── params: $1
                │                                                                               └── body
                │                                                                                    ├── project
                │                                                                                    │    ├── columns: stmt_raise_5:3
                │                                                                                    │    ├── values
                │                                                                                    │    │    └── tuple
                │                                                                                    │    └── projections
                │                                                                                    │         └── function: crdb_internal.plpgsql_raise [as=stmt_raise_5:3]
                │                                                                                    │              ├── const: 'NOTICE'
                │                                                                                    │              ├── concat
                │                                                                                    │              │    ├── concat
                │                                                                                    │              │    │    ├── const: ''
                │                                                                                    │              │    │    └── coalesce
                │                                                                                    │              │    │         ├── cast: STRING
                │                                                                                    │              │    │         │    └── placeholder: $1
                │                                                                                    │              │    │         └── const: '<NULL>'
                │                                                                                    │              │    └── const: ''
                │                                                                                    │              ├── const: ''
                │                                                                                    │              ├── const: ''
                │                                                                                    │              └── const: '00000'
                │                                                                                    └── project
                │                                                                                         ├── columns: "_implicit_return":4
                │                                                                                         ├── values
                │                                                                                         │    └── tuple
                │                                                                                         └── projections
                │                                                                                              └── cast: VOID [as="_implicit_return":4]
                │                                                                                                   └── null
                └── const: 1

# Build an implicit RETURN statement for a routine with OUT params.
exec-ddl
CREATE PROCEDURE p_out(OUT x INT, OUT y INT) AS $$
  BEGIN
    x := 1;
    IF x > 0 THEN
      y := 2;
    END IF;
  END
$$ LANGUAGE PLpgSQL;
----

build format=show-scalars
CALL p_out(NULL, NULL);
----
call
 ├── columns: x:1 y:2
 └── procedure: p_out
      └── body
           └── limit
                ├── columns: stmt_if_2:10
                ├── project
                │    ├── columns: stmt_if_2:10
                │    ├── project
                │    │    ├── columns: x:5!null y:4
                │    │    ├── project
                │    │    │    ├── columns: y:4 x:3
                │    │    │    ├── project
                │    │    │    │    ├── columns: x:3
                │    │    │    │    ├── values
                │    │    │    │    │    └── tuple
                │    │    │    │    └── projections
                │    │    │    │         └── cast: INT8 [as=x:3]
                │    │    │    │              └── null
                │    │    │    └── projections
                │    │    │         └── cast: INT8 [as=y:4]
                │    │    │              └── null
                │    │    └── projections
                │    │         └── const: 1 [as=x:5]
                │    └── projections
                │         └── case [as=stmt_if_2:10]
                │              ├── true
                │              ├── when
                │              │    ├── gt
                │              │    │    ├── variable: x:5
                │              │    │    └── const: 0
                │              │    └── subquery
                │              │         └── project
                │              │              ├── columns: stmt_if_1:8
                │              │              ├── project
                │              │              │    ├── columns: y:7!null
                │              │              │    ├── values
                │              │              │    │    └── tuple
                │              │              │    └── projections
                │              │              │         └── const: 2 [as=y:7]
                │              │              └── projections
                │              │                   └── udf: stmt_if_1 [as=stmt_if_1:8]
                │              │                        ├── tail-call
                │              │                        ├── args
                │              │                        │    ├── variable: x:5
                │              │                        │    └── variable: y:7
                │              │                        ├── params: $1 $2
                │              │                        └── body
                │              │                             └── project
                │              │                                  ├── columns: "_implicit_return":6
                │              │                                  ├── values
                │              │                                  │    └── tuple
                │              │                                  └── projections
                │              │                                       └── cast: RECORD [as="_implicit_return":6]
                │              │                                            └── tuple
                │              │                                                 ├── placeholder: $1
                │              │                                                 └── placeholder: $2
                │              └── subquery
                │                   └── project
                │                        ├── columns: stmt_if_1:9
                │                        ├── values
                │                        │    └── tuple
                │                        └── projections
                │                             └── udf: stmt_if_1 [as=stmt_if_1:9]
                │                                  ├── tail-call
                │                                  ├── args
                │                                  │    ├── variable: x:5
                │                                  │    └── variable: y:4
                │                                  ├── params: $1 $2
                │                                  └── body
                │                                       └── project
                │                                            ├── columns: "_implicit_return":6
                │                                            ├── values
                │                                            │    └── tuple
                │                                            └── projections
                │                                                 └── cast: RECORD [as="_implicit_return":6]
                │                                                      └── tuple
                │                                                           ├── placeholder: $1
                │                                                           └── placeholder: $2
                └── const: 1

exec-ddl
CREATE PROCEDURE p_143171(OUT foo INT) LANGUAGE PLpgSQL AS $$
  BEGIN
    INSERT INTO t VALUES (1, 2, 'foo') RETURNING i INTO foo;
  END;
$$;
----

exec-ddl
CREATE PROCEDURE p2_143171() LANGUAGE PLpgSQL AS $$
  DECLARE foo INT;
  BEGIN
    CALL p_143171(foo);
  END;
$$;
----

# Regression test for #143171 - do not drop the routine invocation that
# corresponds to the p_143171 CALL statement.
build format=show-scalars
CALL p2_143171();
----
call
 └── procedure: p2_143171
      └── body
           └── limit
                ├── columns: "_stmt_call_1":19
                ├── project
                │    ├── columns: "_stmt_call_1":19
                │    ├── barrier
                │    │    ├── columns: foo:1
                │    │    └── project
                │    │         ├── columns: foo:1
                │    │         ├── values
                │    │         │    └── tuple
                │    │         └── projections
                │    │              └── cast: INT8 [as=foo:1]
                │    │                   └── null
                │    └── projections
                │         └── udf: _stmt_call_1 [as="_stmt_call_1":19]
                │              ├── args
                │              │    └── variable: foo:1
                │              ├── params: $1
                │              └── body
                │                   └── project
                │                        ├── columns: "_stmt_call_ret_3":18
                │                        ├── project
                │                        │    ├── columns: foo:16
                │                        │    ├── barrier
                │                        │    │    ├── columns: stmt_call_2:2
                │                        │    │    └── project
                │                        │    │         ├── columns: stmt_call_2:2
                │                        │    │         ├── values
                │                        │    │         │    └── tuple
                │                        │    │         └── projections
                │                        │    │              └── udf: p_143171 [as=stmt_call_2:2]
                │                        │    │                   └── body
                │                        │    │                        └── limit
                │                        │    │                             ├── columns: "_stmt_exec_1":15
                │                        │    │                             ├── project
                │                        │    │                             │    ├── columns: "_stmt_exec_1":15
                │                        │    │                             │    ├── barrier
                │                        │    │                             │    │    ├── columns: foo:3
                │                        │    │                             │    │    └── project
                │                        │    │                             │    │         ├── columns: foo:3
                │                        │    │                             │    │         ├── values
                │                        │    │                             │    │         │    └── tuple
                │                        │    │                             │    │         └── projections
                │                        │    │                             │    │              └── cast: INT8 [as=foo:3]
                │                        │    │                             │    │                   └── null
                │                        │    │                             │    └── projections
                │                        │    │                             │         └── udf: _stmt_exec_1 [as="_stmt_exec_1":15]
                │                        │    │                             │              ├── args
                │                        │    │                             │              │    └── variable: foo:3
                │                        │    │                             │              ├── params: $1
                │                        │    │                             │              └── body
                │                        │    │                             │                   └── project
                │                        │    │                             │                        ├── columns: "_stmt_exec_ret_2":14
                │                        │    │                             │                        ├── project
                │                        │    │                             │                        │    ├── columns: foo:13
                │                        │    │                             │                        │    ├── barrier
                │                        │    │                             │                        │    │    ├── columns: i:5
                │                        │    │                             │                        │    │    └── right-join (cross)
                │                        │    │                             │                        │    │         ├── columns: i:5
                │                        │    │                             │                        │    │         ├── limit
                │                        │    │                             │                        │    │         │    ├── columns: i:5!null
                │                        │    │                             │                        │    │         │    ├── project
                │                        │    │                             │                        │    │         │    │    ├── columns: i:5!null
                │                        │    │                             │                        │    │         │    │    └── insert t
                │                        │    │                             │                        │    │         │    │         ├── columns: k:4!null i:5!null s:6!null
                │                        │    │                             │                        │    │         │    │         ├── insert-mapping:
                │                        │    │                             │                        │    │         │    │         │    ├── column1:9 => k:4
                │                        │    │                             │                        │    │         │    │         │    ├── column2:10 => i:5
                │                        │    │                             │                        │    │         │    │         │    └── column3:11 => s:6
                │                        │    │                             │                        │    │         │    │         ├── return-mapping:
                │                        │    │                             │                        │    │         │    │         │    ├── column1:9 => k:4
                │                        │    │                             │                        │    │         │    │         │    ├── column2:10 => i:5
                │                        │    │                             │                        │    │         │    │         │    └── column3:11 => s:6
                │                        │    │                             │                        │    │         │    │         └── values
                │                        │    │                             │                        │    │         │    │              ├── columns: column1:9!null column2:10!null column3:11!null
                │                        │    │                             │                        │    │         │    │              └── tuple
                │                        │    │                             │                        │    │         │    │                   ├── const: 1
                │                        │    │                             │                        │    │         │    │                   ├── const: 2
                │                        │    │                             │                        │    │         │    │                   └── const: 'foo'
                │                        │    │                             │                        │    │         │    └── const: 1
                │                        │    │                             │                        │    │         ├── values
                │                        │    │                             │                        │    │         │    └── tuple
                │                        │    │                             │                        │    │         └── filters (true)
                │                        │    │                             │                        │    └── projections
                │                        │    │                             │                        │         └── variable: i:5 [as=foo:13]
                │                        │    │                             │                        └── projections
                │                        │    │                             │                             └── udf: _stmt_exec_ret_2 [as="_stmt_exec_ret_2":14]
                │                        │    │                             │                                  ├── tail-call
                │                        │    │                             │                                  ├── args
                │                        │    │                             │                                  │    └── variable: foo:13
                │                        │    │                             │                                  ├── params: $1
                │                        │    │                             │                                  └── body
                │                        │    │                             │                                       └── project
                │                        │    │                             │                                            ├── columns: "_implicit_return":12
                │                        │    │                             │                                            ├── values
                │                        │    │                             │                                            │    └── tuple
                │                        │    │                             │                                            └── projections
                │                        │    │                             │                                                 └── cast: RECORD [as="_implicit_return":12]
                │                        │    │                             │                                                      └── tuple
                │                        │    │                             │                                                           └── placeholder: $1
                │                        │    │                             └── const: 1
                │                        │    └── projections
                │                        │         └── column-access: 0 [as=foo:16]
                │                        │              └── variable: stmt_call_2:2
                │                        └── projections
                │                             └── udf: _stmt_call_ret_3 [as="_stmt_call_ret_3":18]
                │                                  ├── tail-call
                │                                  ├── args
                │                                  │    └── variable: foo:16
                │                                  ├── params: $1
                │                                  └── body
                │                                       └── project
                │                                            ├── columns: "_implicit_return":17
                │                                            ├── values
                │                                            │    └── tuple
                │                                            └── projections
                │                                                 └── cast: VOID [as="_implicit_return":17]
                │                                                      └── null
                └── const: 1
