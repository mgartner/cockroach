exec-ddl
CREATE TABLE xy (x INT PRIMARY KEY, y INT);
----

exec-ddl
CREATE TABLE child (k INT PRIMARY KEY, x INT REFERENCES xy(x) ON UPDATE CASCADE ON DELETE CASCADE);
----

exec-ddl
CREATE TABLE computed (k INT PRIMARY KEY, v INT AS (k + 1) STORED, w INT AS (k + 2) VIRTUAL);
----

exec-ddl
CREATE TABLE ab (a INT, b INT);
----

exec-ddl
CREATE FUNCTION f() RETURNS TRIGGER LANGUAGE PLpgSQL AS $$
  BEGIN
    RETURN COALESCE(NEW, OLD);
  END
$$;
----

# ------------------------------------------------------------------------------
# Row-level BEFORE triggers.
# ------------------------------------------------------------------------------

exec-ddl
CREATE TRIGGER tr BEFORE INSERT OR UPDATE OR DELETE ON xy FOR EACH ROW EXECUTE FUNCTION f();
----

exec-ddl
CREATE TRIGGER tr_child BEFORE INSERT OR UPDATE OR DELETE ON child FOR EACH ROW EXECUTE FUNCTION f();
----

norm format=(hide-all,show-columns)
INSERT INTO xy VALUES (1, 2);
----
insert xy
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── x_new:10 => x:1
 │    └── y_new:11 => y:2
 ├── before-triggers
 │    └── tr
 └── project
      ├── columns: x_new:10 y_new:11 column1:5 column2:6 new:7 f:9
      ├── barrier
      │    ├── columns: column1:5 column2:6 new:7 f:9
      │    └── select
      │         ├── columns: column1:5 column2:6 new:7 f:9
      │         ├── project
      │         │    ├── columns: f:9 column1:5 column2:6 new:7
      │         │    ├── barrier
      │         │    │    ├── columns: column1:5 column2:6 new:7
      │         │    │    └── values
      │         │    │         ├── columns: column1:5 column2:6 new:7
      │         │    │         └── (1, 2, ((1, 2) AS x, y))
      │         │    └── projections
      │         │         └── f(new:7, NULL, 'tr', 'BEFORE', 'ROW', 'INSERT', 53, 'xy', 'xy', 'public', 0, ARRAY[]) [as=f:9]
      │         └── filters
      │              └── f:9 IS DISTINCT FROM NULL
      └── projections
           ├── (f:9).x [as=x_new:10]
           └── (f:9).y [as=y_new:11]

build-post-queries format=(hide-all,show-columns)
UPDATE xy SET y = 3 WHERE x = 1;
----
root
 ├── update xy
 │    ├── columns: <none>
 │    ├── fetch columns: x:5 y:6
 │    ├── update-mapping:
 │    │    ├── x_new:14 => x:1
 │    │    └── y_new:15 => y:2
 │    ├── before-triggers
 │    │    └── tr
 │    ├── input binding: &1
 │    ├── cascades
 │    │    └── child_x_fkey
 │    └── project
 │         ├── columns: x_new:14 y_new:15 x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8 y_new:9 old:10 new:11 f:13
 │         ├── barrier
 │         │    ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8 y_new:9 old:10 new:11 f:13
 │         │    └── select
 │         │         ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8 y_new:9 old:10 new:11 f:13
 │         │         ├── project
 │         │         │    ├── columns: f:13 x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8 y_new:9 old:10 new:11
 │         │         │    ├── barrier
 │         │         │    │    ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8 y_new:9 old:10 new:11
 │         │         │    │    └── project
 │         │         │    │         ├── columns: new:11 x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8 y_new:9 old:10
 │         │         │    │         ├── project
 │         │         │    │         │    ├── columns: old:10 x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8 y_new:9
 │         │         │    │         │    ├── project
 │         │         │    │         │    │    ├── columns: y_new:9 x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8
 │         │         │    │         │    │    ├── select
 │         │         │    │         │    │    │    ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8
 │         │         │    │         │    │    │    ├── scan xy
 │         │         │    │         │    │    │    │    ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8
 │         │         │    │         │    │    │    │    └── flags: avoid-full-scan
 │         │         │    │         │    │    │    └── filters
 │         │         │    │         │    │    │         └── x:5 = 1
 │         │         │    │         │    │    └── projections
 │         │         │    │         │    │         └── 3 [as=y_new:9]
 │         │         │    │         │    └── projections
 │         │         │    │         │         └── ((x:5, y:6) AS x, y) [as=old:10]
 │         │         │    │         └── projections
 │         │         │    │              └── ((x:5, y_new:9) AS x, y) [as=new:11]
 │         │         │    └── projections
 │         │         │         └── f(new:11, old:10, 'tr', 'BEFORE', 'ROW', 'UPDATE', 53, 'xy', 'xy', 'public', 0, ARRAY[]) [as=f:13]
 │         │         └── filters
 │         │              └── f:13 IS DISTINCT FROM NULL
 │         └── projections
 │              ├── (f:13).x [as=x_new:14]
 │              └── (f:13).y [as=y_new:15]
 └── cascade
      └── update child
           ├── columns: <none>
           ├── fetch columns: k:20 child.x:21
           ├── update-mapping:
           │    └── x_new:25 => child.x:17
           ├── before-triggers
           │    └── tr_child
           ├── input binding: &2
           ├── barrier
           │    ├── columns: k:20 child.x:21 x_old:24 x_new:25 old:26 new:27 f:29 "check-rows":30
           │    └── select
           │         ├── columns: k:20 child.x:21 x_old:24 x_new:25 old:26 new:27 f:29 "check-rows":30
           │         ├── barrier
           │         │    ├── columns: k:20 child.x:21 x_old:24 x_new:25 old:26 new:27 f:29 "check-rows":30
           │         │    └── project
           │         │         ├── columns: "check-rows":30 k:20 child.x:21 x_old:24 x_new:25 old:26 new:27 f:29
           │         │         ├── project
           │         │         │    ├── columns: f:29 k:20 child.x:21 x_old:24 x_new:25 old:26 new:27
           │         │         │    ├── barrier
           │         │         │    │    ├── columns: k:20 child.x:21 x_old:24 x_new:25 old:26 new:27
           │         │         │    │    └── project
           │         │         │    │         ├── columns: new:27 k:20 child.x:21 x_old:24 x_new:25 old:26
           │         │         │    │         ├── project
           │         │         │    │         │    ├── columns: old:26 k:20 child.x:21 x_old:24 x_new:25
           │         │         │    │         │    ├── inner-join (hash)
           │         │         │    │         │    │    ├── columns: k:20 child.x:21 x_old:24 x_new:25
           │         │         │    │         │    │    ├── scan child
           │         │         │    │         │    │    │    ├── columns: k:20 child.x:21
           │         │         │    │         │    │    │    └── flags: avoid-full-scan
           │         │         │    │         │    │    ├── select
           │         │         │    │         │    │    │    ├── columns: x_old:24 x_new:25
           │         │         │    │         │    │    │    ├── with-scan &1
           │         │         │    │         │    │    │    │    ├── columns: x_old:24 x_new:25
           │         │         │    │         │    │    │    │    └── mapping:
           │         │         │    │         │    │    │    │         ├──  xy.x:5 => x_old:24
           │         │         │    │         │    │    │    │         └──  x_new:14 => x_new:25
           │         │         │    │         │    │    │    └── filters
           │         │         │    │         │    │    │         └── x_old:24 IS DISTINCT FROM x_new:25
           │         │         │    │         │    │    └── filters
           │         │         │    │         │    │         └── child.x:21 = x_old:24
           │         │         │    │         │    └── projections
           │         │         │    │         │         └── ((k:20, child.x:21) AS k, x) [as=old:26]
           │         │         │    │         └── projections
           │         │         │    │              └── ((k:20, x_new:25) AS k, x) [as=new:27]
           │         │         │    └── projections
           │         │         │         └── f(new:27, old:26, 'tr_child', 'BEFORE', 'ROW', 'UPDATE', 54, 'child', 'child', 'public', 0, ARRAY[]) [as=f:29]
           │         │         └── projections
           │         │              └── CASE WHEN f:29 IS DISTINCT FROM new:27 THEN crdb_internal.plpgsql_raise('ERROR', 'trigger tr_child attempted to modify or filter a row in a cascade operation: ' || new:27::STRING, e'changing the rows updated or deleted by a foreign-key cascade\n can cause constraint violations, and therefore is not allowed', e'to enable this behavior (with risk of constraint violation), set\nthe session variable \'unsafe_allow_triggers_modifying_cascades\' to true', '27000') ELSE CAST(NULL AS INT8) END [as="check-rows":30]
           │         └── filters
           │              └── f:29 IS DISTINCT FROM NULL
           └── f-k-checks
                └── f-k-checks-item: child(x) -> xy(x)
                     └── anti-join (hash)
                          ├── columns: x:31
                          ├── select
                          │    ├── columns: x:31
                          │    ├── with-scan &2
                          │    │    ├── columns: x:31
                          │    │    └── mapping:
                          │    │         └──  x_new:25 => x:31
                          │    └── filters
                          │         └── x:31 IS NOT NULL
                          ├── scan xy
                          │    ├── columns: xy.x:32
                          │    └── flags: avoid-full-scan
                          └── filters
                               └── x:31 = xy.x:32

build-post-queries format=(hide-all,show-columns)
DELETE FROM xy WHERE x = 1;
----
root
 ├── delete xy
 │    ├── columns: <none>
 │    ├── fetch columns: x:5 y:6
 │    ├── before-triggers
 │    │    └── tr
 │    ├── input binding: &1
 │    ├── cascades
 │    │    └── child_x_fkey
 │    └── barrier
 │         ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8 old:9 f:11
 │         └── select
 │              ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8 old:9 f:11
 │              ├── project
 │              │    ├── columns: f:11 x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8 old:9
 │              │    ├── barrier
 │              │    │    ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8 old:9
 │              │    │    └── project
 │              │    │         ├── columns: old:9 x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8
 │              │    │         ├── select
 │              │    │         │    ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8
 │              │    │         │    ├── scan xy
 │              │    │         │    │    ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8
 │              │    │         │    │    └── flags: avoid-full-scan
 │              │    │         │    └── filters
 │              │    │         │         └── x:5 = 1
 │              │    │         └── projections
 │              │    │              └── ((x:5, y:6) AS x, y) [as=old:9]
 │              │    └── projections
 │              │         └── f(NULL, old:9, 'tr', 'BEFORE', 'ROW', 'DELETE', 53, 'xy', 'xy', 'public', 0, ARRAY[]) [as=f:11]
 │              └── filters
 │                   └── f:11 IS DISTINCT FROM NULL
 └── cascade
      └── delete child
           ├── columns: <none>
           ├── fetch columns: k:16 child.x:17
           ├── before-triggers
           │    └── tr_child
           └── barrier
                ├── columns: k:16 child.x:17 old:21 f:23 "check-rows":24
                └── select
                     ├── columns: k:16 child.x:17 old:21 f:23 "check-rows":24
                     ├── barrier
                     │    ├── columns: k:16 child.x:17 old:21 f:23 "check-rows":24
                     │    └── project
                     │         ├── columns: "check-rows":24 k:16 child.x:17 old:21 f:23
                     │         ├── project
                     │         │    ├── columns: f:23 k:16 child.x:17 old:21
                     │         │    ├── barrier
                     │         │    │    ├── columns: k:16 child.x:17 old:21
                     │         │    │    └── project
                     │         │    │         ├── columns: old:21 k:16 child.x:17
                     │         │    │         ├── semi-join (hash)
                     │         │    │         │    ├── columns: k:16 child.x:17
                     │         │    │         │    ├── scan child
                     │         │    │         │    │    ├── columns: k:16 child.x:17
                     │         │    │         │    │    └── flags: avoid-full-scan
                     │         │    │         │    ├── with-scan &1
                     │         │    │         │    │    ├── columns: x:20
                     │         │    │         │    │    └── mapping:
                     │         │    │         │    │         └──  xy.x:5 => x:20
                     │         │    │         │    └── filters
                     │         │    │         │         └── child.x:17 = x:20
                     │         │    │         └── projections
                     │         │    │              └── ((k:16, child.x:17) AS k, x) [as=old:21]
                     │         │    └── projections
                     │         │         └── f(NULL, old:21, 'tr_child', 'BEFORE', 'ROW', 'DELETE', 54, 'child', 'child', 'public', 0, ARRAY[]) [as=f:23]
                     │         └── projections
                     │              └── CASE WHEN f:23 IS DISTINCT FROM old:21 THEN crdb_internal.plpgsql_raise('ERROR', 'trigger tr_child attempted to modify or filter a row in a cascade operation: ' || old:21::STRING, e'changing the rows updated or deleted by a foreign-key cascade\n can cause constraint violations, and therefore is not allowed', e'to enable this behavior (with risk of constraint violation), set\nthe session variable \'unsafe_allow_triggers_modifying_cascades\' to true', '27000') ELSE CAST(NULL AS INT8) END [as="check-rows":24]
                     └── filters
                          └── f:23 IS DISTINCT FROM NULL

build-post-queries format=(hide-all,show-columns)
UPSERT INTO xy VALUES (1, 2);
----
root
 ├── upsert xy
 │    ├── arbiter indexes: xy_pkey
 │    ├── columns: <none>
 │    ├── canary column: x:7
 │    ├── fetch columns: x:7 y:8
 │    ├── insert-mapping:
 │    │    ├── x_new:14 => x:1
 │    │    └── y_new:15 => y:2
 │    ├── update-mapping:
 │    │    ├── upsert_x:21 => x:1
 │    │    └── upsert_y:22 => y:2
 │    ├── before-triggers
 │    │    └── tr
 │    ├── input binding: &1
 │    ├── cascades
 │    │    └── child_x_fkey
 │    └── project
 │         ├── columns: upsert_x:21 upsert_y:22 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 old:16 new:17 f:18 x_new:19 y_new:20
 │         ├── project
 │         │    ├── columns: x_new:19 y_new:20 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 old:16 new:17 f:18
 │         │    ├── barrier
 │         │    │    ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 old:16 new:17 f:18
 │         │    │    └── select
 │         │    │         ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 old:16 new:17 f:18
 │         │    │         ├── project
 │         │    │         │    ├── columns: f:18 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 old:16 new:17
 │         │    │         │    ├── barrier
 │         │    │         │    │    ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 old:16 new:17
 │         │    │         │    │    └── project
 │         │    │         │    │         ├── columns: new:17 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 old:16
 │         │    │         │    │         ├── project
 │         │    │         │    │         │    ├── columns: old:16 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15
 │         │    │         │    │         │    ├── project
 │         │    │         │    │         │    │    ├── columns: x_new:14 y_new:15 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13
 │         │    │         │    │         │    │    ├── barrier
 │         │    │         │    │         │    │    │    ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13
 │         │    │         │    │         │    │    │    └── select
 │         │    │         │    │         │    │    │         ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13
 │         │    │         │    │         │    │    │         ├── project
 │         │    │         │    │         │    │    │         │    ├── columns: f:13 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11
 │         │    │         │    │         │    │    │         │    ├── barrier
 │         │    │         │    │         │    │    │         │    │    ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11
 │         │    │         │    │         │    │    │         │    │    └── project
 │         │    │         │    │         │    │    │         │    │         ├── columns: new:11 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10
 │         │    │         │    │         │    │    │         │    │         ├── left-join (hash)
 │         │    │         │    │         │    │    │         │    │         │    ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10
 │         │    │         │    │         │    │    │         │    │         │    ├── ensure-upsert-distinct-on
 │         │    │         │    │         │    │    │         │    │         │    │    ├── columns: column1:5 column2:6
 │         │    │         │    │         │    │    │         │    │         │    │    ├── grouping columns: column1:5
 │         │    │         │    │         │    │    │         │    │         │    │    ├── values
 │         │    │         │    │         │    │    │         │    │         │    │    │    ├── columns: column1:5 column2:6
 │         │    │         │    │         │    │    │         │    │         │    │    │    └── (1, 2)
 │         │    │         │    │         │    │    │         │    │         │    │    └── aggregations
 │         │    │         │    │         │    │    │         │    │         │    │         └── first-agg [as=column2:6]
 │         │    │         │    │         │    │    │         │    │         │    │              └── column2:6
 │         │    │         │    │         │    │    │         │    │         │    ├── scan xy
 │         │    │         │    │         │    │    │         │    │         │    │    ├── columns: x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10
 │         │    │         │    │         │    │    │         │    │         │    │    └── flags: avoid-full-scan
 │         │    │         │    │         │    │    │         │    │         │    └── filters
 │         │    │         │    │         │    │    │         │    │         │         └── column1:5 = x:7
 │         │    │         │    │         │    │    │         │    │         └── projections
 │         │    │         │    │         │    │    │         │    │              └── ((column1:5, column2:6) AS x, y) [as=new:11]
 │         │    │         │    │         │    │    │         │    └── projections
 │         │    │         │    │         │    │    │         │         └── f(new:11, NULL, 'tr', 'BEFORE', 'ROW', 'INSERT', 53, 'xy', 'xy', 'public', 0, ARRAY[]) [as=f:13]
 │         │    │         │    │         │    │    │         └── filters
 │         │    │         │    │         │    │    │              └── f:13 IS DISTINCT FROM NULL
 │         │    │         │    │         │    │    └── projections
 │         │    │         │    │         │    │         ├── (f:13).x [as=x_new:14]
 │         │    │         │    │         │    │         └── (f:13).y [as=y_new:15]
 │         │    │         │    │         │    └── projections
 │         │    │         │    │         │         └── ((x:7, y:8) AS x, y) [as=old:16]
 │         │    │         │    │         └── projections
 │         │    │         │    │              └── ((x:7, y_new:15) AS x, y) [as=new:17]
 │         │    │         │    └── projections
 │         │    │         │         └── CASE WHEN x:7 IS NOT NULL THEN f(new:17, old:16, 'tr', 'BEFORE', 'ROW', 'UPDATE', 53, 'xy', 'xy', 'public', 0, ARRAY[]) ELSE new:17 END [as=f:18]
 │         │    │         └── filters
 │         │    │              └── f:18 IS DISTINCT FROM NULL
 │         │    └── projections
 │         │         ├── (f:18).x [as=x_new:19]
 │         │         └── (f:18).y [as=y_new:20]
 │         └── projections
 │              ├── CASE WHEN x:7 IS NULL THEN x_new:14 ELSE x_new:19 END [as=upsert_x:21]
 │              └── CASE WHEN x:7 IS NULL THEN y_new:15 ELSE y_new:20 END [as=upsert_y:22]
 └── cascade
      └── update child
           ├── columns: <none>
           ├── fetch columns: k:27 child.x:28
           ├── update-mapping:
           │    └── x_new:32 => child.x:24
           ├── before-triggers
           │    └── tr_child
           ├── input binding: &2
           ├── barrier
           │    ├── columns: k:27 child.x:28 x_old:31 x_new:32 old:33 new:34 f:36 "check-rows":37
           │    └── select
           │         ├── columns: k:27 child.x:28 x_old:31 x_new:32 old:33 new:34 f:36 "check-rows":37
           │         ├── barrier
           │         │    ├── columns: k:27 child.x:28 x_old:31 x_new:32 old:33 new:34 f:36 "check-rows":37
           │         │    └── project
           │         │         ├── columns: "check-rows":37 k:27 child.x:28 x_old:31 x_new:32 old:33 new:34 f:36
           │         │         ├── project
           │         │         │    ├── columns: f:36 k:27 child.x:28 x_old:31 x_new:32 old:33 new:34
           │         │         │    ├── barrier
           │         │         │    │    ├── columns: k:27 child.x:28 x_old:31 x_new:32 old:33 new:34
           │         │         │    │    └── project
           │         │         │    │         ├── columns: new:34 k:27 child.x:28 x_old:31 x_new:32 old:33
           │         │         │    │         ├── project
           │         │         │    │         │    ├── columns: old:33 k:27 child.x:28 x_old:31 x_new:32
           │         │         │    │         │    ├── inner-join (hash)
           │         │         │    │         │    │    ├── columns: k:27 child.x:28 x_old:31 x_new:32
           │         │         │    │         │    │    ├── scan child
           │         │         │    │         │    │    │    ├── columns: k:27 child.x:28
           │         │         │    │         │    │    │    └── flags: avoid-full-scan
           │         │         │    │         │    │    ├── select
           │         │         │    │         │    │    │    ├── columns: x_old:31 x_new:32
           │         │         │    │         │    │    │    ├── with-scan &1
           │         │         │    │         │    │    │    │    ├── columns: x_old:31 x_new:32
           │         │         │    │         │    │    │    │    └── mapping:
           │         │         │    │         │    │    │    │         ├──  xy.x:7 => x_old:31
           │         │         │    │         │    │    │    │         └──  upsert_x:21 => x_new:32
           │         │         │    │         │    │    │    └── filters
           │         │         │    │         │    │    │         └── x_old:31 IS DISTINCT FROM x_new:32
           │         │         │    │         │    │    └── filters
           │         │         │    │         │    │         └── child.x:28 = x_old:31
           │         │         │    │         │    └── projections
           │         │         │    │         │         └── ((k:27, child.x:28) AS k, x) [as=old:33]
           │         │         │    │         └── projections
           │         │         │    │              └── ((k:27, x_new:32) AS k, x) [as=new:34]
           │         │         │    └── projections
           │         │         │         └── f(new:34, old:33, 'tr_child', 'BEFORE', 'ROW', 'UPDATE', 54, 'child', 'child', 'public', 0, ARRAY[]) [as=f:36]
           │         │         └── projections
           │         │              └── CASE WHEN f:36 IS DISTINCT FROM new:34 THEN crdb_internal.plpgsql_raise('ERROR', 'trigger tr_child attempted to modify or filter a row in a cascade operation: ' || new:34::STRING, e'changing the rows updated or deleted by a foreign-key cascade\n can cause constraint violations, and therefore is not allowed', e'to enable this behavior (with risk of constraint violation), set\nthe session variable \'unsafe_allow_triggers_modifying_cascades\' to true', '27000') ELSE CAST(NULL AS INT8) END [as="check-rows":37]
           │         └── filters
           │              └── f:36 IS DISTINCT FROM NULL
           └── f-k-checks
                └── f-k-checks-item: child(x) -> xy(x)
                     └── anti-join (hash)
                          ├── columns: x:38
                          ├── select
                          │    ├── columns: x:38
                          │    ├── with-scan &2
                          │    │    ├── columns: x:38
                          │    │    └── mapping:
                          │    │         └──  x_new:32 => x:38
                          │    └── filters
                          │         └── x:38 IS NOT NULL
                          ├── scan xy
                          │    ├── columns: xy.x:39
                          │    └── flags: avoid-full-scan
                          └── filters
                               └── x:38 = xy.x:39

build-post-queries format=(hide-all,show-columns)
INSERT INTO xy VALUES (1, 2) ON CONFLICT (x) DO UPDATE SET y = 3;
----
root
 ├── upsert xy
 │    ├── arbiter indexes: xy_pkey
 │    ├── columns: <none>
 │    ├── canary column: x:7
 │    ├── fetch columns: x:7 y:8
 │    ├── insert-mapping:
 │    │    ├── x_new:14 => x:1
 │    │    └── y_new:15 => y:2
 │    ├── update-mapping:
 │    │    ├── upsert_x:22 => x:1
 │    │    └── upsert_y:23 => y:2
 │    ├── before-triggers
 │    │    └── tr
 │    ├── input binding: &1
 │    ├── cascades
 │    │    └── child_x_fkey
 │    └── project
 │         ├── columns: upsert_x:22 upsert_y:23 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 y_new:16 old:17 new:18 f:19 x_new:20 y_new:21
 │         ├── project
 │         │    ├── columns: x_new:20 y_new:21 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 y_new:16 old:17 new:18 f:19
 │         │    ├── barrier
 │         │    │    ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 y_new:16 old:17 new:18 f:19
 │         │    │    └── select
 │         │    │         ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 y_new:16 old:17 new:18 f:19
 │         │    │         ├── project
 │         │    │         │    ├── columns: f:19 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 y_new:16 old:17 new:18
 │         │    │         │    ├── barrier
 │         │    │         │    │    ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 y_new:16 old:17 new:18
 │         │    │         │    │    └── project
 │         │    │         │    │         ├── columns: new:18 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 y_new:16 old:17
 │         │    │         │    │         ├── project
 │         │    │         │    │         │    ├── columns: old:17 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15 y_new:16
 │         │    │         │    │         │    ├── project
 │         │    │         │    │         │    │    ├── columns: y_new:16 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13 x_new:14 y_new:15
 │         │    │         │    │         │    │    ├── project
 │         │    │         │    │         │    │    │    ├── columns: x_new:14 y_new:15 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13
 │         │    │         │    │         │    │    │    ├── barrier
 │         │    │         │    │         │    │    │    │    ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13
 │         │    │         │    │         │    │    │    │    └── select
 │         │    │         │    │         │    │    │    │         ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11 f:13
 │         │    │         │    │         │    │    │    │         ├── project
 │         │    │         │    │         │    │    │    │         │    ├── columns: f:13 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11
 │         │    │         │    │         │    │    │    │         │    ├── barrier
 │         │    │         │    │         │    │    │    │         │    │    ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 new:11
 │         │    │         │    │         │    │    │    │         │    │    └── project
 │         │    │         │    │         │    │    │    │         │    │         ├── columns: new:11 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10
 │         │    │         │    │         │    │    │    │         │    │         ├── left-join (hash)
 │         │    │         │    │         │    │    │    │         │    │         │    ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10
 │         │    │         │    │         │    │    │    │         │    │         │    ├── ensure-upsert-distinct-on
 │         │    │         │    │         │    │    │    │         │    │         │    │    ├── columns: column1:5 column2:6
 │         │    │         │    │         │    │    │    │         │    │         │    │    ├── grouping columns: column1:5
 │         │    │         │    │         │    │    │    │         │    │         │    │    ├── values
 │         │    │         │    │         │    │    │    │         │    │         │    │    │    ├── columns: column1:5 column2:6
 │         │    │         │    │         │    │    │    │         │    │         │    │    │    └── (1, 2)
 │         │    │         │    │         │    │    │    │         │    │         │    │    └── aggregations
 │         │    │         │    │         │    │    │    │         │    │         │    │         └── first-agg [as=column2:6]
 │         │    │         │    │         │    │    │    │         │    │         │    │              └── column2:6
 │         │    │         │    │         │    │    │    │         │    │         │    ├── scan xy
 │         │    │         │    │         │    │    │    │         │    │         │    │    ├── columns: x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10
 │         │    │         │    │         │    │    │    │         │    │         │    │    └── flags: avoid-full-scan
 │         │    │         │    │         │    │    │    │         │    │         │    └── filters
 │         │    │         │    │         │    │    │    │         │    │         │         └── column1:5 = x:7
 │         │    │         │    │         │    │    │    │         │    │         └── projections
 │         │    │         │    │         │    │    │    │         │    │              └── ((column1:5, column2:6) AS x, y) [as=new:11]
 │         │    │         │    │         │    │    │    │         │    └── projections
 │         │    │         │    │         │    │    │    │         │         └── f(new:11, NULL, 'tr', 'BEFORE', 'ROW', 'INSERT', 53, 'xy', 'xy', 'public', 0, ARRAY[]) [as=f:13]
 │         │    │         │    │         │    │    │    │         └── filters
 │         │    │         │    │         │    │    │    │              └── f:13 IS DISTINCT FROM NULL
 │         │    │         │    │         │    │    │    └── projections
 │         │    │         │    │         │    │    │         ├── (f:13).x [as=x_new:14]
 │         │    │         │    │         │    │    │         └── (f:13).y [as=y_new:15]
 │         │    │         │    │         │    │    └── projections
 │         │    │         │    │         │    │         └── 3 [as=y_new:16]
 │         │    │         │    │         │    └── projections
 │         │    │         │    │         │         └── ((x:7, y:8) AS x, y) [as=old:17]
 │         │    │         │    │         └── projections
 │         │    │         │    │              └── ((x:7, y_new:16) AS x, y) [as=new:18]
 │         │    │         │    └── projections
 │         │    │         │         └── CASE WHEN x:7 IS NOT NULL THEN f(new:18, old:17, 'tr', 'BEFORE', 'ROW', 'UPDATE', 53, 'xy', 'xy', 'public', 0, ARRAY[]) ELSE new:18 END [as=f:19]
 │         │    │         └── filters
 │         │    │              └── f:19 IS DISTINCT FROM NULL
 │         │    └── projections
 │         │         ├── (f:19).x [as=x_new:20]
 │         │         └── (f:19).y [as=y_new:21]
 │         └── projections
 │              ├── CASE WHEN x:7 IS NULL THEN x_new:14 ELSE x_new:20 END [as=upsert_x:22]
 │              └── CASE WHEN x:7 IS NULL THEN y_new:15 ELSE y_new:21 END [as=upsert_y:23]
 └── cascade
      └── update child
           ├── columns: <none>
           ├── fetch columns: k:28 child.x:29
           ├── update-mapping:
           │    └── x_new:33 => child.x:25
           ├── before-triggers
           │    └── tr_child
           ├── input binding: &2
           ├── barrier
           │    ├── columns: k:28 child.x:29 x_old:32 x_new:33 old:34 new:35 f:37 "check-rows":38
           │    └── select
           │         ├── columns: k:28 child.x:29 x_old:32 x_new:33 old:34 new:35 f:37 "check-rows":38
           │         ├── barrier
           │         │    ├── columns: k:28 child.x:29 x_old:32 x_new:33 old:34 new:35 f:37 "check-rows":38
           │         │    └── project
           │         │         ├── columns: "check-rows":38 k:28 child.x:29 x_old:32 x_new:33 old:34 new:35 f:37
           │         │         ├── project
           │         │         │    ├── columns: f:37 k:28 child.x:29 x_old:32 x_new:33 old:34 new:35
           │         │         │    ├── barrier
           │         │         │    │    ├── columns: k:28 child.x:29 x_old:32 x_new:33 old:34 new:35
           │         │         │    │    └── project
           │         │         │    │         ├── columns: new:35 k:28 child.x:29 x_old:32 x_new:33 old:34
           │         │         │    │         ├── project
           │         │         │    │         │    ├── columns: old:34 k:28 child.x:29 x_old:32 x_new:33
           │         │         │    │         │    ├── inner-join (hash)
           │         │         │    │         │    │    ├── columns: k:28 child.x:29 x_old:32 x_new:33
           │         │         │    │         │    │    ├── scan child
           │         │         │    │         │    │    │    ├── columns: k:28 child.x:29
           │         │         │    │         │    │    │    └── flags: avoid-full-scan
           │         │         │    │         │    │    ├── select
           │         │         │    │         │    │    │    ├── columns: x_old:32 x_new:33
           │         │         │    │         │    │    │    ├── with-scan &1
           │         │         │    │         │    │    │    │    ├── columns: x_old:32 x_new:33
           │         │         │    │         │    │    │    │    └── mapping:
           │         │         │    │         │    │    │    │         ├──  xy.x:7 => x_old:32
           │         │         │    │         │    │    │    │         └──  upsert_x:22 => x_new:33
           │         │         │    │         │    │    │    └── filters
           │         │         │    │         │    │    │         └── x_old:32 IS DISTINCT FROM x_new:33
           │         │         │    │         │    │    └── filters
           │         │         │    │         │    │         └── child.x:29 = x_old:32
           │         │         │    │         │    └── projections
           │         │         │    │         │         └── ((k:28, child.x:29) AS k, x) [as=old:34]
           │         │         │    │         └── projections
           │         │         │    │              └── ((k:28, x_new:33) AS k, x) [as=new:35]
           │         │         │    └── projections
           │         │         │         └── f(new:35, old:34, 'tr_child', 'BEFORE', 'ROW', 'UPDATE', 54, 'child', 'child', 'public', 0, ARRAY[]) [as=f:37]
           │         │         └── projections
           │         │              └── CASE WHEN f:37 IS DISTINCT FROM new:35 THEN crdb_internal.plpgsql_raise('ERROR', 'trigger tr_child attempted to modify or filter a row in a cascade operation: ' || new:35::STRING, e'changing the rows updated or deleted by a foreign-key cascade\n can cause constraint violations, and therefore is not allowed', e'to enable this behavior (with risk of constraint violation), set\nthe session variable \'unsafe_allow_triggers_modifying_cascades\' to true', '27000') ELSE CAST(NULL AS INT8) END [as="check-rows":38]
           │         └── filters
           │              └── f:37 IS DISTINCT FROM NULL
           └── f-k-checks
                └── f-k-checks-item: child(x) -> xy(x)
                     └── anti-join (hash)
                          ├── columns: x:39
                          ├── select
                          │    ├── columns: x:39
                          │    ├── with-scan &2
                          │    │    ├── columns: x:39
                          │    │    └── mapping:
                          │    │         └──  x_new:33 => x:39
                          │    └── filters
                          │         └── x:39 IS NOT NULL
                          ├── scan xy
                          │    ├── columns: xy.x:40
                          │    └── flags: avoid-full-scan
                          └── filters
                               └── x:39 = xy.x:40

# Show interaction with computed columns.
exec-ddl
CREATE TRIGGER tr BEFORE INSERT OR UPDATE ON computed FOR EACH ROW
WHEN ((NEW).v IS NULL AND (NEW).w IS NULL) EXECUTE FUNCTION f();
----

norm format=(hide-all,show-columns)
INSERT INTO computed (k) VALUES (1);
----
insert computed
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── k_new:12 => k:1
 │    ├── v_comp:13 => v:2
 │    └── w_comp:14 => w:3
 ├── before-triggers
 │    └── tr
 └── project
      ├── columns: v_comp:13 w_comp:14 column1:6 v_comp:7 w_comp:8 new:9 f:11 k_new:12
      ├── project
      │    ├── columns: k_new:12 column1:6 v_comp:7 w_comp:8 new:9 f:11
      │    ├── barrier
      │    │    ├── columns: column1:6 v_comp:7 w_comp:8 new:9 f:11
      │    │    └── select
      │    │         ├── columns: column1:6 v_comp:7 w_comp:8 new:9 f:11
      │    │         ├── project
      │    │         │    ├── columns: f:11 column1:6 v_comp:7 w_comp:8 new:9
      │    │         │    ├── barrier
      │    │         │    │    ├── columns: column1:6 v_comp:7 w_comp:8 new:9
      │    │         │    │    └── values
      │    │         │    │         ├── columns: column1:6 v_comp:7 w_comp:8 new:9
      │    │         │    │         └── (1, 2, 3, ((1, NULL, NULL) AS k, v, w))
      │    │         │    └── projections
      │    │         │         └── CASE WHEN ((new:9).v IS NULL) AND ((new:9).w IS NULL) THEN f(new:9, NULL, 'tr', 'BEFORE', 'ROW', 'INSERT', 55, 'computed', 'computed', 'public', 0, ARRAY[]) ELSE new:9 END [as=f:11]
      │    │         └── filters
      │    │              └── f:11 IS DISTINCT FROM NULL
      │    └── projections
      │         └── (f:11).k [as=k_new:12]
      └── projections
           ├── k_new:12 + 1 [as=v_comp:13]
           └── k_new:12 + 2 [as=w_comp:14]

norm format=(hide-all,show-columns)
UPDATE computed SET k = 2 WHERE k = 1;
----
update computed
 ├── columns: <none>
 ├── fetch columns: k:6 v:7 w:8
 ├── update-mapping:
 │    ├── k_new:18 => k:1
 │    ├── v_comp:19 => v:2
 │    └── w_comp:20 => w:3
 ├── before-triggers
 │    └── tr
 └── project
      ├── columns: v_comp:19 w_comp:20 k:6 v:7 w:8 k_new:18
      ├── project
      │    ├── columns: k_new:18 k:6 v:7 w:8
      │    ├── barrier
      │    │    ├── columns: k:6 v:7 w:8 crdb_internal_mvcc_timestamp:9 tableoid:10 k_new:11 v_comp:12 w_comp:13 old:14 new:15 f:17
      │    │    └── select
      │    │         ├── columns: k:6 v:7 w:8 crdb_internal_mvcc_timestamp:9 tableoid:10 k_new:11 v_comp:12 w_comp:13 old:14 new:15 f:17
      │    │         ├── project
      │    │         │    ├── columns: f:17 k:6 v:7 w:8 crdb_internal_mvcc_timestamp:9 tableoid:10 k_new:11 v_comp:12 w_comp:13 old:14 new:15
      │    │         │    ├── barrier
      │    │         │    │    ├── columns: k:6 v:7 w:8 crdb_internal_mvcc_timestamp:9 tableoid:10 k_new:11 v_comp:12 w_comp:13 old:14 new:15
      │    │         │    │    └── project
      │    │         │    │         ├── columns: new:15 old:14 v_comp:12 w_comp:13 k_new:11 w:8 k:6 v:7 crdb_internal_mvcc_timestamp:9 tableoid:10
      │    │         │    │         ├── select
      │    │         │    │         │    ├── columns: k:6 v:7 crdb_internal_mvcc_timestamp:9 tableoid:10
      │    │         │    │         │    ├── scan computed
      │    │         │    │         │    │    ├── columns: k:6 v:7 crdb_internal_mvcc_timestamp:9 tableoid:10
      │    │         │    │         │    │    ├── computed column expressions
      │    │         │    │         │    │    │    ├── v:7
      │    │         │    │         │    │    │    │    └── k:6 + 1
      │    │         │    │         │    │    │    └── w:8
      │    │         │    │         │    │    │         └── k:6 + 2
      │    │         │    │         │    │    └── flags: avoid-full-scan
      │    │         │    │         │    └── filters
      │    │         │    │         │         └── k:6 = 1
      │    │         │    │         └── projections
      │    │         │    │              ├── ((2, NULL, NULL) AS k, v, w) [as=new:15]
      │    │         │    │              ├── ((k:6, CAST(NULL AS INT8), CAST(NULL AS INT8)) AS k, v, w) [as=old:14]
      │    │         │    │              ├── 3 [as=v_comp:12]
      │    │         │    │              ├── 4 [as=w_comp:13]
      │    │         │    │              ├── 2 [as=k_new:11]
      │    │         │    │              └── k:6 + 2 [as=w:8]
      │    │         │    └── projections
      │    │         │         └── CASE WHEN ((new:15).v IS NULL) AND ((new:15).w IS NULL) THEN f(new:15, old:14, 'tr', 'BEFORE', 'ROW', 'UPDATE', 55, 'computed', 'computed', 'public', 0, ARRAY[]) ELSE new:15 END [as=f:17]
      │    │         └── filters
      │    │              └── f:17 IS DISTINCT FROM NULL
      │    └── projections
      │         └── (f:17).k [as=k_new:18]
      └── projections
           ├── k_new:18 + 1 [as=v_comp:19]
           └── k_new:18 + 2 [as=w_comp:20]

# Test a trigger that fires itself recursively.
exec-ddl
CREATE FUNCTION insert_ab() RETURNS TRIGGER AS $$
  BEGIN
    INSERT INTO ab VALUES ((NEW).a, (NEW).b);
    RETURN NEW;
  END;
$$ LANGUAGE PLpgSQL;
----

exec-ddl
CREATE TRIGGER tr BEFORE INSERT OR UPDATE ON ab FOR EACH ROW EXECUTE FUNCTION insert_ab();
----

norm format=(hide-all,show-columns,show-scalars)
INSERT INTO ab VALUES (1, 2);
----
insert ab
 ├── columns: <none>
 ├── insert-mapping:
 │    ├── a_new:25 => a:1
 │    ├── b_new:26 => b:2
 │    └── rowid_default:8 => rowid:3
 ├── before-triggers
 │    └── tr
 └── project
      ├── columns: a_new:25 b_new:26 column1:6 column2:7 rowid_default:8 new:9 insert_ab:24
      ├── barrier
      │    ├── columns: column1:6 column2:7 rowid_default:8 new:9 insert_ab:24
      │    └── select
      │         ├── columns: column1:6 column2:7 rowid_default:8 new:9 insert_ab:24
      │         ├── project
      │         │    ├── columns: insert_ab:24 column1:6 column2:7 rowid_default:8 new:9
      │         │    ├── barrier
      │         │    │    ├── columns: column1:6 column2:7 rowid_default:8 new:9
      │         │    │    └── values
      │         │    │         ├── columns: column1:6 column2:7 rowid_default:8 new:9
      │         │    │         └── tuple
      │         │    │              ├── const: 1
      │         │    │              ├── const: 2
      │         │    │              ├── function: unique_rowid
      │         │    │              └── tuple
      │         │    │                   ├── const: 1
      │         │    │                   └── const: 2
      │         │    └── projections
      │         │         └── udf: insert_ab [as=insert_ab:24]
      │         │              ├── args
      │         │              │    ├── variable: new:9
      │         │              │    ├── null
      │         │              │    ├── const: 'tr'
      │         │              │    ├── const: 'BEFORE'
      │         │              │    ├── const: 'ROW'
      │         │              │    ├── const: 'INSERT'
      │         │              │    ├── const: 56
      │         │              │    ├── const: 'ab'
      │         │              │    ├── const: 'ab'
      │         │              │    ├── const: 'public'
      │         │              │    ├── const: 0
      │         │              │    └── const: ARRAY[]
      │         │              ├── params: $1 $2 $3 $4 $5 $6 $7 $8 $9 $10 $11 $12
      │         │              └── body
      │         │                   └── values
      │         │                        ├── columns: "_stmt_exec_1":23
      │         │                        └── tuple
      │         │                             └── udf: _stmt_exec_1
      │         │                                  ├── tail-call
      │         │                                  ├── args
      │         │                                  │    ├── placeholder: $1
      │         │                                  │    ├── placeholder: $2
      │         │                                  │    ├── placeholder: $3
      │         │                                  │    ├── placeholder: $4
      │         │                                  │    ├── placeholder: $5
      │         │                                  │    ├── placeholder: $6
      │         │                                  │    ├── placeholder: $7
      │         │                                  │    ├── placeholder: $8
      │         │                                  │    ├── placeholder: $9
      │         │                                  │    ├── placeholder: $10
      │         │                                  │    ├── placeholder: $11
      │         │                                  │    └── placeholder: $12
      │         │                                  ├── params: $1 $2 $3 $4 $5 $6 $7 $8 $9 $10 $11 $12
      │         │                                  └── body
      │         │                                       ├── insert ab
      │         │                                       │    ├── columns: <none>
      │         │                                       │    ├── insert-mapping:
      │         │                                       │    │    ├── a_new:20 => a:10
      │         │                                       │    │    ├── b_new:21 => b:11
      │         │                                       │    │    └── rowid_default:17 => rowid:12
      │         │                                       │    ├── before-triggers
      │         │                                       │    │    └── tr
      │         │                                       │    └── project
      │         │                                       │         ├── columns: a_new:20 b_new:21 column1:15 column2:16 rowid_default:17 new:18 insert_ab:19
      │         │                                       │         ├── barrier
      │         │                                       │         │    ├── columns: column1:15 column2:16 rowid_default:17 new:18 insert_ab:19
      │         │                                       │         │    └── select
      │         │                                       │         │         ├── columns: column1:15 column2:16 rowid_default:17 new:18 insert_ab:19
      │         │                                       │         │         ├── project
      │         │                                       │         │         │    ├── columns: insert_ab:19 column1:15 column2:16 rowid_default:17 new:18
      │         │                                       │         │         │    ├── barrier
      │         │                                       │         │         │    │    ├── columns: column1:15 column2:16 rowid_default:17 new:18
      │         │                                       │         │         │    │    └── project
      │         │                                       │         │         │    │         ├── columns: new:18 column1:15 column2:16 rowid_default:17
      │         │                                       │         │         │    │         ├── values
      │         │                                       │         │         │    │         │    ├── columns: column1:15 column2:16 rowid_default:17
      │         │                                       │         │         │    │         │    └── tuple
      │         │                                       │         │         │    │         │         ├── column-access: 0
      │         │                                       │         │         │    │         │         │    └── placeholder: $1
      │         │                                       │         │         │    │         │         ├── column-access: 1
      │         │                                       │         │         │    │         │         │    └── placeholder: $1
      │         │                                       │         │         │    │         │         └── function: unique_rowid
      │         │                                       │         │         │    │         └── projections
      │         │                                       │         │         │    │              └── tuple [as=new:18]
      │         │                                       │         │         │    │                   ├── variable: column1:15
      │         │                                       │         │         │    │                   └── variable: column2:16
      │         │                                       │         │         │    └── projections
      │         │                                       │         │         │         └── udf: insert_ab [as=insert_ab:19]
      │         │                                       │         │         │              ├── args
      │         │                                       │         │         │              │    ├── variable: new:18
      │         │                                       │         │         │              │    ├── null
      │         │                                       │         │         │              │    ├── const: 'tr'
      │         │                                       │         │         │              │    ├── const: 'BEFORE'
      │         │                                       │         │         │              │    ├── const: 'ROW'
      │         │                                       │         │         │              │    ├── const: 'INSERT'
      │         │                                       │         │         │              │    ├── const: 56
      │         │                                       │         │         │              │    ├── const: 'ab'
      │         │                                       │         │         │              │    ├── const: 'ab'
      │         │                                       │         │         │              │    ├── const: 'public'
      │         │                                       │         │         │              │    ├── const: 0
      │         │                                       │         │         │              │    └── const: ARRAY[]
      │         │                                       │         │         │              └── recursive-call
      │         │                                       │         │         └── filters
      │         │                                       │         │              └── is-not
      │         │                                       │         │                   ├── variable: insert_ab:19
      │         │                                       │         │                   └── null
      │         │                                       │         └── projections
      │         │                                       │              ├── column-access: 0 [as=a_new:20]
      │         │                                       │              │    └── variable: insert_ab:19
      │         │                                       │              └── column-access: 1 [as=b_new:21]
      │         │                                       │                   └── variable: insert_ab:19
      │         │                                       └── values
      │         │                                            ├── columns: stmt_return_2:22
      │         │                                            └── tuple
      │         │                                                 └── placeholder: $1
      │         └── filters
      │              └── is-not
      │                   ├── variable: insert_ab:24
      │                   └── null
      └── projections
           ├── column-access: 0 [as=a_new:25]
           │    └── variable: insert_ab:24
           └── column-access: 1 [as=b_new:26]
                └── variable: insert_ab:24

# ------------------------------------------------------------------------------
# Row-level AFTER triggers.
# ------------------------------------------------------------------------------

exec-ddl
DROP TRIGGER tr ON xy;
----

exec-ddl
CREATE TRIGGER tr AFTER INSERT OR UPDATE OR DELETE ON xy FOR EACH ROW EXECUTE FUNCTION f();
----

build-post-queries format=(hide-all,show-columns)
INSERT INTO xy VALUES (1, 2);
----
root
 ├── insert xy
 │    ├── columns: <none>
 │    ├── insert-mapping:
 │    │    ├── column1:5 => x:1
 │    │    └── column2:6 => y:2
 │    ├── input binding: &1
 │    ├── after-triggers
 │    │    └── tr
 │    └── values
 │         ├── columns: column1:5 column2:6
 │         └── (1, 2)
 └── after-triggers
      └── barrier
           ├── columns: column1_new:7 column2_new:8 old:9 new:10 f:12
           └── project
                ├── columns: f:12 column1_new:7 column2_new:8 old:9 new:10
                ├── project
                │    ├── columns: new:10 column1_new:7 column2_new:8 old:9
                │    ├── project
                │    │    ├── columns: old:9 column1_new:7 column2_new:8
                │    │    ├── with-scan &1
                │    │    │    ├── columns: column1_new:7 column2_new:8
                │    │    │    └── mapping:
                │    │    │         ├──  column1:5 => column1_new:7
                │    │    │         └──  column2:6 => column2_new:8
                │    │    └── projections
                │    │         └── NULL [as=old:9]
                │    └── projections
                │         └── ((column1_new:7, column2_new:8) AS x, y) [as=new:10]
                └── projections
                     └── f(new:10, old:9, 'tr', 'AFTER', 'ROW', 'INSERT', 53, 'xy', 'xy', 'public', 0, ARRAY[]) [as=f:12]

build-post-queries format=(hide-all,show-columns)
UPDATE xy SET y = 3 WHERE x = 1;
----
root
 ├── update xy
 │    ├── columns: <none>
 │    ├── fetch columns: x:5 y:6
 │    ├── update-mapping:
 │    │    └── y_new:9 => y:2
 │    ├── input binding: &1
 │    ├── after-triggers
 │    │    └── tr
 │    └── project
 │         ├── columns: y_new:9 x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8
 │         ├── select
 │         │    ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8
 │         │    ├── scan xy
 │         │    │    ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8
 │         │    │    └── flags: avoid-full-scan
 │         │    └── filters
 │         │         └── x:5 = 1
 │         └── projections
 │              └── 3 [as=y_new:9]
 └── after-triggers
      └── barrier
           ├── columns: x_old:10 y_old:11 x_new:12 y_new_new:13 old:14 new:15 f:17
           └── project
                ├── columns: f:17 x_old:10 y_old:11 x_new:12 y_new_new:13 old:14 new:15
                ├── project
                │    ├── columns: new:15 x_old:10 y_old:11 x_new:12 y_new_new:13 old:14
                │    ├── project
                │    │    ├── columns: old:14 x_old:10 y_old:11 x_new:12 y_new_new:13
                │    │    ├── with-scan &1
                │    │    │    ├── columns: x_old:10 y_old:11 x_new:12 y_new_new:13
                │    │    │    └── mapping:
                │    │    │         ├──  x:5 => x_old:10
                │    │    │         ├──  y:6 => y_old:11
                │    │    │         ├──  x:5 => x_new:12
                │    │    │         └──  y_new:9 => y_new_new:13
                │    │    └── projections
                │    │         └── ((x_old:10, y_old:11) AS x, y) [as=old:14]
                │    └── projections
                │         └── ((x_new:12, y_new_new:13) AS x, y) [as=new:15]
                └── projections
                     └── f(new:15, old:14, 'tr', 'AFTER', 'ROW', 'UPDATE', 53, 'xy', 'xy', 'public', 0, ARRAY[]) [as=f:17]

build-post-queries format=(hide-all,show-columns)
DELETE FROM xy WHERE x = 1;
----
root
 ├── delete xy
 │    ├── columns: <none>
 │    ├── fetch columns: x:5 y:6
 │    ├── input binding: &1
 │    ├── cascades
 │    │    └── child_x_fkey
 │    ├── after-triggers
 │    │    └── tr
 │    └── select
 │         ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8
 │         ├── scan xy
 │         │    ├── columns: x:5 y:6 crdb_internal_mvcc_timestamp:7 tableoid:8
 │         │    └── flags: avoid-full-scan
 │         └── filters
 │              └── x:5 = 1
 ├── cascade
 │    └── delete child
 │         ├── columns: <none>
 │         ├── fetch columns: k:13 child.x:14
 │         ├── before-triggers
 │         │    └── tr_child
 │         └── barrier
 │              ├── columns: k:13 child.x:14 old:17 f:19 "check-rows":20
 │              └── select
 │                   ├── columns: k:13 child.x:14 old:17 f:19 "check-rows":20
 │                   ├── barrier
 │                   │    ├── columns: k:13 child.x:14 old:17 f:19 "check-rows":20
 │                   │    └── project
 │                   │         ├── columns: "check-rows":20 k:13 child.x:14 old:17 f:19
 │                   │         ├── project
 │                   │         │    ├── columns: f:19 k:13 child.x:14 old:17
 │                   │         │    ├── barrier
 │                   │         │    │    ├── columns: k:13 child.x:14 old:17
 │                   │         │    │    └── project
 │                   │         │    │         ├── columns: old:17 k:13 child.x:14
 │                   │         │    │         ├── select
 │                   │         │    │         │    ├── columns: k:13 child.x:14
 │                   │         │    │         │    ├── scan child
 │                   │         │    │         │    │    ├── columns: k:13 child.x:14
 │                   │         │    │         │    │    └── flags: avoid-full-scan
 │                   │         │    │         │    └── filters
 │                   │         │    │         │         ├── child.x:14 = 1
 │                   │         │    │         │         └── child.x:14 IS DISTINCT FROM CAST(NULL AS INT8)
 │                   │         │    │         └── projections
 │                   │         │    │              └── ((k:13, child.x:14) AS k, x) [as=old:17]
 │                   │         │    └── projections
 │                   │         │         └── f(NULL, old:17, 'tr_child', 'BEFORE', 'ROW', 'DELETE', 54, 'child', 'child', 'public', 0, ARRAY[]) [as=f:19]
 │                   │         └── projections
 │                   │              └── CASE WHEN f:19 IS DISTINCT FROM old:17 THEN crdb_internal.plpgsql_raise('ERROR', 'trigger tr_child attempted to modify or filter a row in a cascade operation: ' || old:17::STRING, e'changing the rows updated or deleted by a foreign-key cascade\n can cause constraint violations, and therefore is not allowed', e'to enable this behavior (with risk of constraint violation), set\nthe session variable \'unsafe_allow_triggers_modifying_cascades\' to true', '27000') ELSE CAST(NULL AS INT8) END [as="check-rows":20]
 │                   └── filters
 │                        └── f:19 IS DISTINCT FROM NULL
 └── after-triggers
      └── barrier
           ├── columns: x_old:21 y_old:22 old:23 new:24 f:26
           └── project
                ├── columns: f:26 x_old:21 y_old:22 old:23 new:24
                ├── project
                │    ├── columns: new:24 x_old:21 y_old:22 old:23
                │    ├── project
                │    │    ├── columns: old:23 x_old:21 y_old:22
                │    │    ├── with-scan &1
                │    │    │    ├── columns: x_old:21 y_old:22
                │    │    │    └── mapping:
                │    │    │         ├──  xy.x:5 => x_old:21
                │    │    │         └──  y:6 => y_old:22
                │    │    └── projections
                │    │         └── ((x_old:21, y_old:22) AS x, y) [as=old:23]
                │    └── projections
                │         └── NULL [as=new:24]
                └── projections
                     └── f(new:24, old:23, 'tr', 'AFTER', 'ROW', 'DELETE', 53, 'xy', 'xy', 'public', 0, ARRAY[]) [as=f:26]

build-post-queries format=(hide-all,show-columns)
UPSERT INTO xy VALUES (1, 2);
----
root
 ├── upsert xy
 │    ├── arbiter indexes: xy_pkey
 │    ├── columns: <none>
 │    ├── canary column: x:7
 │    ├── fetch columns: x:7 y:8
 │    ├── insert-mapping:
 │    │    ├── column1:5 => x:1
 │    │    └── column2:6 => y:2
 │    ├── update-mapping:
 │    │    └── column2:6 => y:2
 │    ├── input binding: &1
 │    ├── after-triggers
 │    │    └── tr
 │    └── project
 │         ├── columns: upsert_x:11 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10
 │         ├── left-join (hash)
 │         │    ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10
 │         │    ├── ensure-upsert-distinct-on
 │         │    │    ├── columns: column1:5 column2:6
 │         │    │    ├── grouping columns: column1:5
 │         │    │    ├── values
 │         │    │    │    ├── columns: column1:5 column2:6
 │         │    │    │    └── (1, 2)
 │         │    │    └── aggregations
 │         │    │         └── first-agg [as=column2:6]
 │         │    │              └── column2:6
 │         │    ├── scan xy
 │         │    │    ├── columns: x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10
 │         │    │    └── flags: avoid-full-scan
 │         │    └── filters
 │         │         └── column1:5 = x:7
 │         └── projections
 │              └── CASE WHEN x:7 IS NULL THEN column1:5 ELSE x:7 END [as=upsert_x:11]
 └── after-triggers
      └── barrier
           ├── columns: canary:12 x_old:13 y_old:14 x_new:15 column2_new:16 column1_new:17 column2_new:18 old:19 new:20 f:22
           └── project
                ├── columns: f:22 canary:12 x_old:13 y_old:14 x_new:15 column2_new:16 column1_new:17 column2_new:18 old:19 new:20
                ├── project
                │    ├── columns: new:20 canary:12 x_old:13 y_old:14 x_new:15 column2_new:16 column1_new:17 column2_new:18 old:19
                │    ├── project
                │    │    ├── columns: old:19 canary:12 x_old:13 y_old:14 x_new:15 column2_new:16 column1_new:17 column2_new:18
                │    │    ├── with-scan &1
                │    │    │    ├── columns: canary:12 x_old:13 y_old:14 x_new:15 column2_new:16 column1_new:17 column2_new:18
                │    │    │    └── mapping:
                │    │    │         ├──  x:7 => canary:12
                │    │    │         ├──  x:7 => x_old:13
                │    │    │         ├──  y:8 => y_old:14
                │    │    │         ├──  x:7 => x_new:15
                │    │    │         ├──  column2:6 => column2_new:16
                │    │    │         ├──  column1:5 => column1_new:17
                │    │    │         └──  column2:6 => column2_new:18
                │    │    └── projections
                │    │         └── CASE WHEN canary:12 IS NULL THEN CAST(NULL AS RECORD) ELSE ((x_old:13, y_old:14) AS x, y) END [as=old:19]
                │    └── projections
                │         └── CASE WHEN canary:12 IS NULL THEN ((column1_new:17, column2_new:18) AS x, y) ELSE ((x_new:15, column2_new:16) AS x, y) END [as=new:20]
                └── projections
                     └── f(new:20, old:19, 'tr', 'AFTER', 'ROW', CASE WHEN canary:12 IS NULL THEN 'INSERT' ELSE 'UPDATE' END, 53, 'xy', 'xy', 'public', 0, ARRAY[]) [as=f:22]

build-post-queries format=(hide-all,show-columns)
INSERT INTO xy VALUES (1, 2) ON CONFLICT (x) DO UPDATE SET y = 3;
----
root
 ├── upsert xy
 │    ├── arbiter indexes: xy_pkey
 │    ├── columns: <none>
 │    ├── canary column: x:7
 │    ├── fetch columns: x:7 y:8
 │    ├── insert-mapping:
 │    │    ├── column1:5 => x:1
 │    │    └── column2:6 => y:2
 │    ├── update-mapping:
 │    │    └── upsert_y:13 => y:2
 │    ├── input binding: &1
 │    ├── after-triggers
 │    │    └── tr
 │    └── project
 │         ├── columns: upsert_x:12 upsert_y:13 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10 y_new:11
 │         ├── project
 │         │    ├── columns: y_new:11 column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10
 │         │    ├── left-join (hash)
 │         │    │    ├── columns: column1:5 column2:6 x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10
 │         │    │    ├── ensure-upsert-distinct-on
 │         │    │    │    ├── columns: column1:5 column2:6
 │         │    │    │    ├── grouping columns: column1:5
 │         │    │    │    ├── values
 │         │    │    │    │    ├── columns: column1:5 column2:6
 │         │    │    │    │    └── (1, 2)
 │         │    │    │    └── aggregations
 │         │    │    │         └── first-agg [as=column2:6]
 │         │    │    │              └── column2:6
 │         │    │    ├── scan xy
 │         │    │    │    ├── columns: x:7 y:8 crdb_internal_mvcc_timestamp:9 tableoid:10
 │         │    │    │    └── flags: avoid-full-scan
 │         │    │    └── filters
 │         │    │         └── column1:5 = x:7
 │         │    └── projections
 │         │         └── 3 [as=y_new:11]
 │         └── projections
 │              ├── CASE WHEN x:7 IS NULL THEN column1:5 ELSE x:7 END [as=upsert_x:12]
 │              └── CASE WHEN x:7 IS NULL THEN column2:6 ELSE y_new:11 END [as=upsert_y:13]
 └── after-triggers
      └── barrier
           ├── columns: canary:14 x_old:15 y_old:16 x_new:17 upsert_y_new:18 column1_new:19 column2_new:20 old:21 new:22 f:24
           └── project
                ├── columns: f:24 canary:14 x_old:15 y_old:16 x_new:17 upsert_y_new:18 column1_new:19 column2_new:20 old:21 new:22
                ├── project
                │    ├── columns: new:22 canary:14 x_old:15 y_old:16 x_new:17 upsert_y_new:18 column1_new:19 column2_new:20 old:21
                │    ├── project
                │    │    ├── columns: old:21 canary:14 x_old:15 y_old:16 x_new:17 upsert_y_new:18 column1_new:19 column2_new:20
                │    │    ├── with-scan &1
                │    │    │    ├── columns: canary:14 x_old:15 y_old:16 x_new:17 upsert_y_new:18 column1_new:19 column2_new:20
                │    │    │    └── mapping:
                │    │    │         ├──  x:7 => canary:14
                │    │    │         ├──  x:7 => x_old:15
                │    │    │         ├──  y:8 => y_old:16
                │    │    │         ├──  x:7 => x_new:17
                │    │    │         ├──  upsert_y:13 => upsert_y_new:18
                │    │    │         ├──  column1:5 => column1_new:19
                │    │    │         └──  column2:6 => column2_new:20
                │    │    └── projections
                │    │         └── CASE WHEN canary:14 IS NULL THEN CAST(NULL AS RECORD) ELSE ((x_old:15, y_old:16) AS x, y) END [as=old:21]
                │    └── projections
                │         └── CASE WHEN canary:14 IS NULL THEN ((column1_new:19, column2_new:20) AS x, y) ELSE ((x_new:17, upsert_y_new:18) AS x, y) END [as=new:22]
                └── projections
                     └── f(new:22, old:21, 'tr', 'AFTER', 'ROW', CASE WHEN canary:14 IS NULL THEN 'INSERT' ELSE 'UPDATE' END, 53, 'xy', 'xy', 'public', 0, ARRAY[]) [as=f:24]

# Case with multiple triggers.
exec-ddl
CREATE TRIGGER tr2 AFTER INSERT ON xy FOR EACH ROW EXECUTE FUNCTION f();
----

build-post-queries format=(hide-all,show-columns)
INSERT INTO xy VALUES (1, 2);
----
root
 ├── insert xy
 │    ├── columns: <none>
 │    ├── insert-mapping:
 │    │    ├── column1:5 => x:1
 │    │    └── column2:6 => y:2
 │    ├── input binding: &1
 │    ├── after-triggers
 │    │    ├── tr
 │    │    └── tr2
 │    └── values
 │         ├── columns: column1:5 column2:6
 │         └── (1, 2)
 └── after-triggers
      └── barrier
           ├── columns: column1_new:7 column2_new:8 old:9 new:10 f:12 f:14
           └── project
                ├── columns: f:14 column1_new:7 column2_new:8 old:9 new:10 f:12
                ├── barrier
                │    ├── columns: column1_new:7 column2_new:8 old:9 new:10 f:12
                │    └── project
                │         ├── columns: f:12 column1_new:7 column2_new:8 old:9 new:10
                │         ├── project
                │         │    ├── columns: new:10 column1_new:7 column2_new:8 old:9
                │         │    ├── project
                │         │    │    ├── columns: old:9 column1_new:7 column2_new:8
                │         │    │    ├── with-scan &1
                │         │    │    │    ├── columns: column1_new:7 column2_new:8
                │         │    │    │    └── mapping:
                │         │    │    │         ├──  column1:5 => column1_new:7
                │         │    │    │         └──  column2:6 => column2_new:8
                │         │    │    └── projections
                │         │    │         └── NULL [as=old:9]
                │         │    └── projections
                │         │         └── ((column1_new:7, column2_new:8) AS x, y) [as=new:10]
                │         └── projections
                │              └── f(new:10, old:9, 'tr', 'AFTER', 'ROW', 'INSERT', 53, 'xy', 'xy', 'public', 0, ARRAY[]) [as=f:12]
                └── projections
                     └── f(new:10, old:9, 'tr2', 'AFTER', 'ROW', 'INSERT', 53, 'xy', 'xy', 'public', 0, ARRAY[]) [as=f:14]

# ------------------------------------------------------------------------------
# Regression tests.
# ------------------------------------------------------------------------------

# Regression test for #133329 - do not inline insert values into uniqueness
# checks when the table has row-level BEFORE triggers that could modify the
# rows.
exec-ddl
CREATE TABLE t133329 (k INT PRIMARY KEY, a INT UNIQUE WITHOUT INDEX);
----

build format=(hide-all,show-fastpathchecks)
INSERT INTO t133329 VALUES (1, 1);
----
insert t133329
 ├── values
 │    └── (1, 1)
 ├── unique-checks
 │    └── unique-checks-item: t133329(a)
 │         └── project
 │              └── semi-join (hash)
 │                   ├── values
 │                   │    └── (1, 1)
 │                   ├── scan t133329
 │                   │    └── flags: avoid-full-scan
 │                   └── filters
 │                        ├── a = t133329.a
 │                        └── k != t133329.k
 └── fast-path-unique-checks
      └── fast-path-unique-checks-item: t133329(a)
           └── select
                ├── scan t133329
                │    └── flags: avoid-full-scan
                └── filters
                     └── t133329.a = 1

exec-ddl
CREATE FUNCTION f133329() RETURNS TRIGGER LANGUAGE PLpgSQL AS $$
  BEGIN
    RETURN NEW;
  END
$$;
----

exec-ddl
CREATE TRIGGER tr BEFORE INSERT ON t133329 FOR EACH ROW EXECUTE FUNCTION f();
----

build format=(hide-all,show-fastpathchecks)
INSERT INTO t133329 VALUES (1, 1);
----
insert t133329
 ├── project
 │    ├── barrier
 │    │    └── select
 │    │         ├── project
 │    │         │    ├── barrier
 │    │         │    │    └── project
 │    │         │    │         ├── values
 │    │         │    │         │    └── (1, 1)
 │    │         │    │         └── projections
 │    │         │    │              └── ((column1, column2) AS k, a)
 │    │         │    └── projections
 │    │         │         └── f(new, NULL, 'tr', 'BEFORE', 'ROW', 'INSERT', 59, 't133329', 't133329', 'public', 0, ARRAY[])
 │    │         └── filters
 │    │              └── f IS DISTINCT FROM NULL
 │    └── projections
 │         ├── (f).k
 │         └── (f).a
 └── unique-checks
      └── unique-checks-item: t133329(a)
           └── project
                └── semi-join (hash)
                     ├── with-scan &1
                     ├── scan t133329
                     │    └── flags: avoid-full-scan
                     └── filters
                          ├── a = t133329.a
                          └── k != t133329.k

# Regression test for #154672. Do not set target columns when re-projecting
# computed columns after a BEFORE trigger.
exec-ddl
CREATE TABLE t154672 (
  k INT PRIMARY KEY,
  a INT,
  b INT AS (a + 1) STORED
)
----

exec-ddl
CREATE FUNCTION f154672() RETURNS TRIGGER LANGUAGE PLpgSQL AS $$
  BEGIN
    RETURN COALESCE(NEW, OLD);
  END
$$
----

exec-ddl
CREATE TRIGGER tr154672 BEFORE INSERT OR UPDATE OR DELETE ON t154672 FOR EACH ROW EXECUTE FUNCTION f154672()
----

norm
INSERT INTO t154672 (k, a) VALUES (1, 2) ON CONFLICT (k) DO UPDATE SET a = 3
----
upsert t154672
 ├── arbiter indexes: t154672_pkey
 ├── columns: <none>
 ├── canary column: k:9
 ├── fetch columns: k:9 a:10 b:11
 ├── insert-mapping:
 │    ├── k_new:17 => k:1
 │    ├── a_new:18 => a:2
 │    └── b_comp:19 => b:3
 ├── update-mapping:
 │    ├── upsert_k:28 => k:1
 │    ├── upsert_a:29 => a:2
 │    └── upsert_b:30 => b:3
 ├── before-triggers
 │    └── tr154672
 └── project
      ├── columns: upsert_k:28 upsert_a:29 upsert_b:30 k:9 a:10 b:11 k_new:17 a_new:18 b_comp:19
      ├── project
      │    ├── columns: k_new:25 a_new:26 k:9 a:10 b:11 k_new:17 a_new:18 b_comp:19
      │    ├── barrier
      │    │    ├── columns: column1:6!null column2:7!null b_comp:8!null k:9 a:10 b:11 crdb_internal_mvcc_timestamp:12 tableoid:13 new:14 f154672:16!null k_new:17 a_new:18 b_comp:19 a_new:20!null b_comp:21!null old:22 new:23 f154672:24!null
      │    │    └── select
      │    │         ├── columns: column1:6!null column2:7!null b_comp:8!null k:9 a:10 b:11 crdb_internal_mvcc_timestamp:12 tableoid:13 new:14 f154672:16!null k_new:17 a_new:18 b_comp:19 a_new:20!null b_comp:21!null old:22 new:23 f154672:24!null
      │    │         ├── project
      │    │         │    ├── columns: f154672:24 column1:6!null column2:7!null b_comp:8!null k:9 a:10 b:11 crdb_internal_mvcc_timestamp:12 tableoid:13 new:14 f154672:16!null k_new:17 a_new:18 b_comp:19 a_new:20!null b_comp:21!null old:22 new:23
      │    │         │    ├── barrier
      │    │         │    │    ├── columns: column1:6!null column2:7!null b_comp:8!null k:9 a:10 b:11 crdb_internal_mvcc_timestamp:12 tableoid:13 new:14 f154672:16!null k_new:17 a_new:18 b_comp:19 a_new:20!null b_comp:21!null old:22 new:23
      │    │         │    │    └── project
      │    │         │    │         ├── columns: new:23 old:22 b_comp:21!null a_new:20!null b_comp:19 k_new:17 a_new:18 column1:6!null column2:7!null b_comp:8!null k:9 a:10 b:11 crdb_internal_mvcc_timestamp:12 tableoid:13 new:14 f154672:16!null
      │    │         │    │         ├── barrier
      │    │         │    │         │    ├── columns: column1:6!null column2:7!null b_comp:8!null k:9 a:10 b:11 crdb_internal_mvcc_timestamp:12 tableoid:13 new:14 f154672:16!null
      │    │         │    │         │    └── select
      │    │         │    │         │         ├── columns: column1:6!null column2:7!null b_comp:8!null k:9 a:10 b:11 crdb_internal_mvcc_timestamp:12 tableoid:13 new:14 f154672:16!null
      │    │         │    │         │         ├── project
      │    │         │    │         │         │    ├── columns: f154672:16 column1:6!null column2:7!null b_comp:8!null k:9 a:10 b:11 crdb_internal_mvcc_timestamp:12 tableoid:13 new:14
      │    │         │    │         │         │    ├── barrier
      │    │         │    │         │         │    │    ├── columns: column1:6!null column2:7!null b_comp:8!null k:9 a:10 b:11 crdb_internal_mvcc_timestamp:12 tableoid:13 new:14
      │    │         │    │         │         │    │    └── project
      │    │         │    │         │         │    │         ├── columns: new:14 column1:6!null column2:7!null b_comp:8!null k:9 a:10 b:11 crdb_internal_mvcc_timestamp:12 tableoid:13
      │    │         │    │         │         │    │         ├── left-join (cross)
      │    │         │    │         │         │    │         │    ├── columns: column1:6!null column2:7!null b_comp:8!null k:9 a:10 b:11 crdb_internal_mvcc_timestamp:12 tableoid:13
      │    │         │    │         │         │    │         │    ├── values
      │    │         │    │         │         │    │         │    │    ├── columns: column1:6!null column2:7!null b_comp:8!null
      │    │         │    │         │         │    │         │    │    └── (1, 2, 3)
      │    │         │    │         │         │    │         │    ├── select
      │    │         │    │         │         │    │         │    │    ├── columns: k:9!null a:10 b:11 crdb_internal_mvcc_timestamp:12 tableoid:13
      │    │         │    │         │         │    │         │    │    ├── scan t154672
      │    │         │    │         │         │    │         │    │    │    ├── columns: k:9!null a:10 b:11 crdb_internal_mvcc_timestamp:12 tableoid:13
      │    │         │    │         │         │    │         │    │    │    ├── computed column expressions
      │    │         │    │         │         │    │         │    │    │    │    └── b:11
      │    │         │    │         │         │    │         │    │    │    │         └── a:10 + 1
      │    │         │    │         │         │    │         │    │    │    └── flags: avoid-full-scan disabled not visible index feature
      │    │         │    │         │         │    │         │    │    └── filters
      │    │         │    │         │         │    │         │    │         └── k:9 = 1
      │    │         │    │         │         │    │         │    └── filters (true)
      │    │         │    │         │         │    │         └── projections
      │    │         │    │         │         │    │              └── ((column1:6, column2:7, CAST(NULL AS INT8)) AS k, a, b) [as=new:14]
      │    │         │    │         │         │    └── projections
      │    │         │    │         │         │         └── f154672(new:14, NULL, 'tr154672', 'BEFORE', 'ROW', 'INSERT', 61, 't154672', 't154672', 'public', 0, ARRAY[]) [as=f154672:16]
      │    │         │    │         │         └── filters
      │    │         │    │         │              └── f154672:16 IS DISTINCT FROM NULL
      │    │         │    │         └── projections
      │    │         │    │              ├── ((k:9, 3, CAST(NULL AS INT8)) AS k, a, b) [as=new:23]
      │    │         │    │              ├── ((k:9, a:10, CAST(NULL AS INT8)) AS k, a, b) [as=old:22]
      │    │         │    │              ├── 4 [as=b_comp:21]
      │    │         │    │              ├── 3 [as=a_new:20]
      │    │         │    │              ├── a:10 + 1 [as=b_comp:19]
      │    │         │    │              ├── (f154672:16).k [as=k_new:17]
      │    │         │    │              └── (f154672:16).a [as=a_new:18]
      │    │         │    └── projections
      │    │         │         └── CASE WHEN k:9 IS NOT NULL THEN f154672(new:23, old:22, 'tr154672', 'BEFORE', 'ROW', 'UPDATE', 61, 't154672', 't154672', 'public', 0, ARRAY[]) ELSE new:23 END [as=f154672:24]
      │    │         └── filters
      │    │              └── f154672:24 IS DISTINCT FROM NULL
      │    └── projections
      │         ├── (f154672:24).k [as=k_new:25]
      │         └── (f154672:24).a [as=a_new:26]
      └── projections
           ├── CASE WHEN k:9 IS NULL THEN k_new:17 ELSE k_new:25 END [as=upsert_k:28]
           ├── CASE WHEN k:9 IS NULL THEN a_new:18 ELSE a_new:26 END [as=upsert_a:29]
           └── CASE WHEN k:9 IS NULL THEN b_comp:19 ELSE a_new:26 + 1 END [as=upsert_b:30]
